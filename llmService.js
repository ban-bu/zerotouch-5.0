// [MODIFIED] Deepbricks LLMå¤„ç†æœåŠ¡
// Impact: åˆ‡æ¢åˆ° Deepbricks APIï¼Œæ¨¡å‹ GPT-5-Chat
// Backward Compatibility: ä¿ç•™åŸæœ‰å‡½æ•°/å¸¸é‡å‘½åä¸è¯·æ±‚ç»“æ„ï¼Œè°ƒç”¨æ–¹æ— éœ€æ”¹åŠ¨

// Deepbricks APIé…ç½®
const MODELSCOPE_CONFIG = {
  // [MODIFIED]
  baseURL: 'https://api.deepbricks.ai/v1/',
  model: 'GPT-5-Chat',
  apiKey: 'sk-lNVAREVHjj386FDCd9McOL7k66DZCUkTp6IbV0u9970qqdlg'
}

// æ—¥å¿—è¾…åŠ©å‡½æ•°ï¼ˆé¿å…è¾“å‡ºè¿‡é•¿å†…å®¹å’Œæ•æ„Ÿä¿¡æ¯ï¼‰
const truncateForLog = (text, maxLength = 2000) => {
  if (typeof text !== 'string') return text
  if (text.length <= maxLength) return text
  return text.slice(0, maxLength) + 'â€¦(truncated)'
}

const formatMessagesForLog = (messages) => {
  try {
    return messages.map(m => ({
      role: m.role,
      content: truncateForLog(m.content)
    }))
  } catch (_) {
    return '[unserializable messages]'
  }
}

// è°ƒç”¨é­”æ­APIçš„é€šç”¨å‡½æ•°
const callModelScopeAPI = async (messages, temperature = 0.7, maxTokens = 4096) => {
  try {
    const isDev = typeof import.meta !== 'undefined' && import.meta.env && import.meta.env.DEV
    console.group('[LLM] Request Details')
    console.log('ğŸ”¹ Model:', MODELSCOPE_CONFIG.model)
    console.log('ğŸ”¹ Temperature:', temperature)
    console.log('ğŸ”¹ Total Messages:', messages.length)
    
    // å§‹ç»ˆæ˜¾ç¤ºå®Œæ•´çš„promptå†…å®¹ï¼ˆæ ¼å¼åŒ–åï¼‰
    console.group('ğŸ“ Complete Prompt Content')
    try {
      messages.forEach((message, index) => {
        console.group(`ğŸ’¬ Message ${index + 1}: [${message.role.toUpperCase()}]`)
        console.log(message.content)
        console.groupEnd()
      })
    } catch (error) {
      console.log('Error displaying messages:', error)
    }
    console.groupEnd()
    
    // å¼€å‘ç¯å¢ƒä¸‹é¢å¤–æ˜¾ç¤ºJSONæ ¼å¼
    if (isDev) {
      console.group('ğŸ”§ Debug Info (JSON Format)')
      try {
        console.log('messages JSON:', JSON.stringify(messages, null, 2))
      } catch (_) {
        console.log('Failed to serialize messages to JSON')
      }
      console.groupEnd()
    }
    
    console.time('[LLM] â±ï¸ Request Latency')
    // [MODIFIED] Deepbricks å…¼å®¹ OpenAI Chat Completions è·¯ç”±
    const response = await fetch(`${MODELSCOPE_CONFIG.baseURL}chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${MODELSCOPE_CONFIG.apiKey}`
      },
      body: JSON.stringify({
        model: MODELSCOPE_CONFIG.model,
        messages: messages,
        temperature: temperature,
        max_tokens: maxTokens,
        stream: false
      })
    })

    if (!response.ok) {
      console.timeEnd('[LLM] â±ï¸ Request Latency')
      console.log('âŒ HTTP Status:', response.status, response.statusText)
      
      // å°è¯•è·å–è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
      let errorDetail = ''
      try {
        const errorData = await response.json()
        console.log('âŒ API Error Details:', errorData)
        errorDetail = errorData.error?.message || errorData.message || ''
      } catch (e) {
        console.log('âŒ Failed to parse error response')
      }
      
      console.groupEnd()
      const errorMsg = errorDetail ? `APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText} - ${errorDetail}` : `APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`
      throw new Error(errorMsg)
    }

    const data = await response.json()
    const content = data?.choices?.[0]?.message?.content
    
    console.timeEnd('[LLM] â±ï¸ Request Latency')
    
    // æ˜¾ç¤ºå“åº”ä¿¡æ¯
    console.group('ğŸ“¤ Response Details')
    if (data?.usage) {
      console.log('ğŸ’° Token Usage:', data.usage)
    }
    console.log('âœ… Response Length:', content?.length || 0, 'characters')
    console.groupEnd()
    
    // æ˜¾ç¤ºå®Œæ•´çš„å“åº”å†…å®¹
    console.group('ğŸ“‹ Complete Response Content')
    console.log(content || '(Empty response)')
    console.groupEnd()
    
    // å¼€å‘ç¯å¢ƒä¸‹æ˜¾ç¤ºåŸå§‹æ•°æ®
    if (isDev) {
      console.group('ğŸ”§ Raw Response Data')
      try { 
        console.log('Full API Response:', JSON.stringify(data, null, 2))
      } catch (_) {
        console.log('Failed to serialize response data')
      }
      console.groupEnd()
    }
    
    console.groupEnd()
    return content
  } catch (error) {
    try { console.groupEnd() } catch (_) {}
    console.groupCollapsed('[LLM] Error')
    console.error('é­”æ­APIè°ƒç”¨é”™è¯¯:', error)
    console.groupEnd()
    throw error
  }
}

// ç»Ÿä¸€æ¸…ç†è¾“å‡ºæ–‡æœ¬ï¼Œç§»é™¤å½±å“ä½“éªŒçš„æ¨¡æ¿åŒ–è‡´æ­‰æˆ–å¼•å¯¼è¯­
const sanitizeOutput = (text) => {
  if (!text) return text
  const bannedPhrases = [
    'éå¸¸æŠ±æ­‰',
    'æŠ±æ­‰',
    'æˆ‘æœªèƒ½ç†è§£',
    'è¯·æ‚¨è¯¦ç»†æè¿°',
    'è¯·æä¾›æ›´å¤šä¿¡æ¯',
    'ä¿¡æ¯ä¸è¶³',
    'è‹¥æœ‰ä¸ç¬¦è¯·æŒ‡æ­£',
    'ä½ å¥½ï¼å¾ˆé«˜å…´èƒ½å¸®åŠ©ä½ ã€‚',
    'è¯·é—®ä½ ç°åœ¨æ˜¯åœ¨å¯»æ‰¾ä»€ä¹ˆç±»å‹çš„å•†å“',
    'è¡£æœã€é‹å­è¿˜æ˜¯å…¶ä»–ä»€ä¹ˆå°ç‰©ä»¶',
    'æ„Ÿè°¢æ‚¨çš„åé¦ˆ',
    'æˆ‘ä»¬éå¸¸é‡è§†',
    'å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜',
    'å¦‚éœ€.*å¸®åŠ©',
    'è¯·éšæ—¶è”ç³»',
    'å®¢æœå›¢é˜Ÿ',
    'æ”¯æŒå›¢é˜Ÿ',
    'ä¸ºæ‚¨æä¾›æ»¡æ„çš„è§£å†³æ–¹æ¡ˆ',
    'æˆ‘ä»¬ä¼šå°½åŠ›.*è§£å†³',
    'æ•¬è¯·è°…è§£',
    'å¿½ç•¥æœ¬æ¬¡å¯¹è¯',
    'ç»§ç»­æµè§ˆå…¶ä»–æœåŠ¡æˆ–ä¿¡æ¯',
    'æ¬¢è¿.*è”ç³»æˆ‘ä»¬'
  ]
  let sanitized = text
  bannedPhrases.forEach((p) => {
    const regex = new RegExp(p, 'g')
    sanitized = sanitized.replace(regex, '')
  })
  return sanitized.trim()
}

// ä¸“é—¨ç”¨äºè¿½é—®å’Œå»ºè®®çš„æ¸©å’Œæ¸…ç†å‡½æ•°
const sanitizeFollowUpOutput = (text) => {
  if (!text) return text
  // åªç§»é™¤æ˜æ˜¾çš„æ¨¡æ¿åŒ–å†…å®¹ï¼Œé¿å…è¯¯åˆ æ­£å¸¸çš„è¿½é—®å†…å®¹
  const bannedPhrases = [
    '^éå¸¸æŠ±æ­‰.*$',  // åªåŒ¹é…å¼€å¤´çš„é“æ­‰
    '^æŠ±æ­‰.*$',      // åªåŒ¹é…å¼€å¤´çš„é“æ­‰
    'æˆ‘æœªèƒ½ç†è§£æ‚¨çš„éœ€æ±‚',
    'è¯·æ‚¨è¯¦ç»†æè¿°ä¸€ä¸‹',
    'ä¿¡æ¯ä¸è¶³ï¼Œæ— æ³•',
    'è‹¥æœ‰ä¸ç¬¦è¯·æŒ‡æ­£',
    'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬éå¸¸é‡è§†',
    'å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»',
    'å®¢æœå›¢é˜Ÿä¼šä¸ºæ‚¨',
    'æ”¯æŒå›¢é˜Ÿä¼šä¸ºæ‚¨',
    'æ•¬è¯·è°…è§£'
  ]
  let sanitized = text
  bannedPhrases.forEach((p) => {
    const regex = new RegExp(p, 'gm')
    sanitized = sanitized.replace(regex, '')
  })
  return sanitized.trim()
}

// ä¿è¯ä¸ºå®Œæ•´å¥å­ï¼šè‹¥æœ«å°¾æ— ç»ˆæ­¢æ ‡ç‚¹ï¼Œåˆ™è¡¥ä¸€ä¸ªå¥å·
const ensureCompleteSentence = (text) => {
  if (!text) return text
  const trimmed = text.trim()
  if (/[ã€‚.!ï¼Ÿï¼?]$/.test(trimmed)) return trimmed
  return trimmed + 'ã€‚'
}

// ä¿è¯ä¸ºå®Œæ•´è¯­å¥ï¼šä¿æŒåŸæœ‰æ ‡ç‚¹ç¬¦å·
const ensureQuestionEnding = (text) => {
  if (!text) return text
  let trimmed = text.trim()
  // å¦‚æœæ²¡æœ‰ä»»ä½•æ ‡ç‚¹ç¬¦å·ç»“å°¾ï¼Œæ·»åŠ å¥å·
  if (!/[ã€‚.!ï¼ï¼Ÿ?]$/.test(trimmed)) {
    trimmed = trimmed + 'ã€‚'
  }
  return trimmed
}

// ç§»é™¤å¼€å¤´å¯’æš„/å®¢å¥—ï¼ˆä»…å¤„ç†æ–‡æœ¬å¼€å¤´ï¼Œé¿å…è¯¯åˆ æ­£æ–‡ï¼‰
const stripLeadingPleasantries = (text) => {
  if (!text) return text
  let out = text.trim()
  out = out.replace(/^(ä½ å¥½|æ‚¨å¥½|å—¨|hello|hi)[ï¼!ï¼Œ,ã€‚\s]*/i, '')
  out = out.replace(/^(å¾ˆé«˜å…´[\s\S]{0,20}?)[ã€‚.!ï¼ï¼Ÿ!?]+\s*/i, '')
  out = out.replace(/^(æ„Ÿè°¢[\s\S]{0,20}?)[ã€‚.!ï¼ï¼Ÿ!?]+\s*/i, '')
  out = out.replace(/^(è°¢è°¢[\s\S]{0,20}?)[ã€‚.!ï¼ï¼Ÿ!?]+\s*/i, '')
  return out.trim()
}

// ç²—ç•¥åˆ¤å®šè¾“å‡ºæ˜¯å¦è¿‡çŸ­æˆ–ç–‘ä¼¼æœªæˆå¥
const isWeakOneSentence = (text) => {
  if (!text) return true
  const t = text.trim()
  if (t.length < 12) return true
  if (/^(ä½ å¥½|æ‚¨å¥½|å—¨|hello|hi)/i.test(t)) return true
  if (/[èƒ½ä¼šå¯]$/.test(t)) return true
  return false
}

// [MODIFIED] å¥å£®çš„è§£æä¸å‰¥ç¦»å·¥å…·ï¼Œé¿å…å°†AIå»ºè®®å†æ¬¡è½¬è¯‘
// Impact: ç¡®ä¿å‘å¾€æ–¹æ¡ˆç«¯(`solution`)çš„ `llm_request` ä»…åŒ…å«ã€Œéœ€æ±‚è½¬è¯‘ã€æ–‡æœ¬
// Backward Compatibility: ä¸æ”¹å˜å¯¹å¤–APIï¼Œä»…å¢å¼ºè§£æé²æ£’æ€§
const findFirstIndex = (text, keywords) => {
  for (const keyword of keywords) {
    const idx = text.indexOf(keyword)
    if (idx !== -1) return { idx, keyword }
  }
  return { idx: -1, keyword: '' }
}

// æ„å»ºèŠå¤©å†å²ä¸Šä¸‹æ–‡çš„é€šç”¨å‡½æ•°ï¼ŒåŒ…å«è¯¦ç»†æ—¥å¿—
const buildChatContextWithLogging = (chatHistory, contextType = 'èŠå¤©å†å²ä¸Šä¸‹æ–‡', maxMessages = 6) => {
  if (!chatHistory || chatHistory.length === 0) {
    console.log('â„¹ï¸ No chat history available for context')
    return ''
  }
  
  // è®°å½•å®Œæ•´çš„èŠå¤©å†å²åˆ°æ§åˆ¶å°
  console.group('ğŸ” Chat History Analysis')
  console.log(`ğŸ“Š Total History Messages: ${chatHistory.length}`)
  console.log(`ğŸ“ Using Recent Messages: ${Math.min(chatHistory.length, maxMessages)}`)
  
  const recentHistory = chatHistory.slice(-maxMessages)
  recentHistory.forEach((msg, index) => {
    let role = 'AIå¤„ç†'
    
    // å¢å¼ºçš„è§’è‰²æ˜ å°„é€»è¾‘ï¼ŒåŒ…å«é”™è¯¯æ£€æµ‹å’Œæ™ºèƒ½æ¨æ–­
    if (msg.type === 'user') {
      if (msg.panel === 'problem') {
        role = 'å®¢æˆ·'
      } else if (msg.panel === 'solution') {
        role = 'ä¼ä¸šç«¯'
      } else {
        // å¦‚æœpanelå­—æ®µç¼ºå¤±æˆ–æ— æ•ˆï¼Œå°è¯•æ™ºèƒ½æ¨æ–­
        const content = msg.text?.toLowerCase() || ''
        if (content.includes('é€€è´§') || content.includes('æŠ•è¯‰') || content.includes('ä¸æ»¡') || 
            content.includes('cnm') || content.includes('è‰') || content.includes('å¦ˆ')) {
          role = 'å®¢æˆ·'
        } else {
          role = 'ä¼ä¸šç«¯'
        }
      }
    } else if (msg.type === 'ai_response') {
      role = msg.panel === 'problem' ? 'ç³»ç»Ÿå›å¤ç»™å®¢æˆ·' : 'ç³»ç»Ÿå›å¤ç»™ä¼ä¸šç«¯'
    } else if (msg.type === 'llm_request') {
      role = 'AIéœ€æ±‚è½¬è¯‘'
    }
    
    const preview = msg.text?.substring(0, 100)
    const truncated = msg.text?.length > 100 ? '...' : ''
    
    // è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
    console.log(`${index + 1}. [${role}]: ${preview}${truncated}`)
    console.log(`   ğŸ” Debug: type="${msg.type}", panel="${msg.panel}", timestamp="${msg.timestamp}"`)
  })
  console.groupEnd()
  
  const chatContext = `\n\n${contextType}ï¼š\n` + 
    recentHistory.map((msg, index) => {
      let role = 'AIå¤„ç†'
      
      // å¢å¼ºçš„è§’è‰²æ˜ å°„é€»è¾‘ï¼ŒåŒ…å«é”™è¯¯æ£€æµ‹å’Œæ™ºèƒ½æ¨æ–­
      if (msg.type === 'user') {
        if (msg.panel === 'problem') {
          role = 'å®¢æˆ·'
        } else if (msg.panel === 'solution') {
          role = 'ä¼ä¸šç«¯'
        } else {
          // å¦‚æœpanelå­—æ®µç¼ºå¤±æˆ–æ— æ•ˆï¼Œå°è¯•æ™ºèƒ½æ¨æ–­
          console.warn(`âš ï¸ æ¶ˆæ¯panelå­—æ®µå¼‚å¸¸: panel="${msg.panel}", å†…å®¹é¢„è§ˆ: "${msg.text?.substring(0, 50)}..."`)
          // æ ¹æ®æ¶ˆæ¯å†…å®¹çš„ç‰¹å¾è¿›è¡Œæ™ºèƒ½åˆ¤æ–­
          const content = msg.text?.toLowerCase() || ''
          if (content.includes('é€€è´§') || content.includes('æŠ•è¯‰') || content.includes('ä¸æ»¡') || 
              content.includes('cnm') || content.includes('è‰') || content.includes('å¦ˆ')) {
            role = 'å®¢æˆ·'
            console.log(`ğŸ”§ æ™ºèƒ½æ¨æ–­: æ ¹æ®å†…å®¹ç‰¹å¾åˆ¤æ–­ä¸ºå®¢æˆ·æ¶ˆæ¯`)
          } else {
            role = 'ä¼ä¸šç«¯'
          }
        }
      } else if (msg.type === 'ai_response') {
        role = msg.panel === 'problem' ? 'ç³»ç»Ÿå›å¤ç»™å®¢æˆ·' : 'ç³»ç»Ÿå›å¤ç»™ä¼ä¸šç«¯'
      } else if (msg.type === 'llm_request') {
        role = 'AIéœ€æ±‚è½¬è¯‘'
      }
      
      return `${index + 1}. ${role}: ${msg.text}`
    }).join('\n')
  
  return chatContext
}

const parseSectionsRobust = (raw) => {
  const text = typeof raw === 'string' ? raw : ''
  const sections = {
    translation: '',
    solutionsText: '',
    confirmationsText: ''
  }

  // å¤šæ ‡é¢˜å…¼å®¹
  const translationKeys = ['ã€éœ€æ±‚è½¬è¯‘ã€‘', 'ã€éœ€æ±‚ç¿»è¯‘ã€‘', 'ã€è½¬è¯‘ç»“æœã€‘', 'ã€éœ€æ±‚æ¾„æ¸…ã€‘', 'éœ€æ±‚è½¬è¯‘', 'éœ€æ±‚ç¿»è¯‘', 'è½¬è¯‘ç»“æœ', 'éœ€æ±‚æ¾„æ¸…', 'å®¢æˆ·éœ€æ±‚è½¬è¯‘', 'ç”¨æˆ·éœ€æ±‚è½¬è¯‘']
  const solutionKeys = ['ã€è§£å†³æ–¹æ¡ˆå»ºè®®ã€‘', 'ã€å»ºè®®æ–¹æ¡ˆã€‘', 'ã€è¡ŒåŠ¨å»ºè®®ã€‘', 'è§£å†³æ–¹æ¡ˆå»ºè®®', 'å»ºè®®çš„è§£å†³æ–¹æ¡ˆ', 'æ–¹æ¡ˆå»ºè®®', 'è¡ŒåŠ¨å»ºè®®']
  const confirmKeys = ['ã€å¾…ç¡®è®¤ä¿¡æ¯ã€‘', 'ã€éœ€ç¡®è®¤ä¿¡æ¯ã€‘', 'ã€å¾…ç¡®è®¤ã€‘', 'å¾…ç¡®è®¤ä¿¡æ¯', 'éœ€ç¡®è®¤ä¿¡æ¯']

  const t = findFirstIndex(text, translationKeys)
  const s = findFirstIndex(text, solutionKeys)
  const c = findFirstIndex(text, confirmKeys)

  const endOf = (startIdx) => {
    if (startIdx === -1) return text.length
    const candidates = [s.idx, c.idx, text.length].filter((v) => v !== -1 && v > startIdx)
    return Math.min(...candidates)
  }

  // å–éœ€æ±‚è½¬è¯‘
  if (t.idx !== -1) {
    const start = t.idx + t.keyword.length
    const end = endOf(t.idx)
    sections.translation = text.slice(start, end).trim()
  } else if (s.idx !== -1) {
    // æœªæ‰¾åˆ°è½¬è¯‘æ ‡é¢˜ï¼Œä½†æ‰¾åˆ°æ–¹æ¡ˆæ ‡é¢˜ï¼šå–æ–¹æ¡ˆä¹‹å‰å†…å®¹ä½œä¸ºè½¬è¯‘
    sections.translation = text.slice(0, s.idx).trim()
  }

  // å–æ–¹æ¡ˆå»ºè®®ï¼ˆä¸­ä»‹é¢æ¿å±•ç¤ºç”¨ï¼‰
  if (s.idx !== -1) {
    const start = s.idx + s.keyword.length
    const end = c.idx !== -1 ? c.idx : text.length
    sections.solutionsText = text.slice(start, end).trim()
  }

  // å–å¾…ç¡®è®¤ä¿¡æ¯ï¼ˆä¸­ä»‹é¢æ¿å±•ç¤ºç”¨ï¼‰
  if (c.idx !== -1) {
    const start = c.idx + c.keyword.length
    sections.confirmationsText = text.slice(start).trim()
  }

  // å…œåº•ï¼šè‹¥ä»æœªæŠ½å–åˆ°è½¬è¯‘ï¼Œå°½é‡å‰¥ç¦»æ˜æ˜¾â€œæ–¹æ¡ˆ/å»ºè®®â€æ®µè½
  if (!sections.translation) {
    const firstSolutionIdx = s.idx !== -1 ? s.idx : text.search(/\n?\s*(æ–¹æ¡ˆ|é€‰é¡¹|å»ºè®®)\s*[1-9]/)
    if (firstSolutionIdx !== -1 && firstSolutionIdx > 0) {
      sections.translation = text.slice(0, firstSolutionIdx).trim()
    } else {
      const truncated = text.slice(0, 500)
      const split = truncated.split(/\n{2,}/)
      sections.translation = (split[0] || truncated).trim()
    }
  }

  return sections
}

// å¤„ç†é—®é¢˜ç«¯è¾“å…¥ - å¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒèŠå¤©å†å²å’Œæ·±åº¦ç†è§£
const processProblemInput = async (content, image, scenario, chatHistory = []) => {
  try {
    // æ ¹æ®åœºæ™¯å®šåˆ¶æç¤ºè¯ - å¢å¼ºç‰ˆæœ¬
    const scenarioPrompts = {
      retail: {
        systemRole: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIæ²Ÿé€šåŠ©æ‰‹ï¼Œä¸“é—¨åœ¨é¡¾å®¢ä¸ä¼ä¸šé—¨åº—ä¹‹é—´æä¾›ç²¾å‡†çš„éœ€æ±‚è½¬è¯‘å’Œè§£å†³æ–¹æ¡ˆå»ºè®®ã€‚ä½ çš„æ ¸å¿ƒèŒè´£æ˜¯ï¼š1)å‡†ç¡®ç†è§£é¡¾å®¢çš„çœŸå®éœ€æ±‚å’Œæ½œåœ¨æ„å›¾ 2)å°†å…¶è½¬åŒ–ä¸ºä¼ä¸šèƒ½å¤Ÿç†è§£å’Œæ‰§è¡Œçš„ä¸“ä¸šæè¿° 3)åŸºäºä¼ä¸šèƒ½åŠ›æä¾›å…·ä½“å¯è¡Œçš„è§£å†³æ–¹æ¡ˆé€‰é¡¹ 4)æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åœºæ™¯è¾¹ç•Œï¼šé›¶å”®é¡¾å®¢-é—¨åº—æ²Ÿé€šã€‚ä½ éœ€è¦åŒæ—¶ç†è§£åŒæ–¹å¯èƒ½å­˜åœ¨çš„è¡¨è¾¾åå·®ï¼šé¡¾å®¢å¯èƒ½è¡¨è¾¾ä¸æ¸…æ™°æˆ–æœ‰éšå«éœ€æ±‚ï¼Œä¼ä¸šå¯èƒ½ç”¨ä¸“ä¸šæœ¯è¯­å›å¤ã€‚\n\næ ¸å¿ƒä»»åŠ¡ï¼š\n1. æ·±åº¦ç†è§£ï¼šåˆ†æé¡¾å®¢çš„æ˜¾æ€§éœ€æ±‚å’Œéšæ€§éœ€æ±‚ï¼Œè¯†åˆ«å¯èƒ½çš„è¡¨è¾¾åå·®\n2. ç²¾å‡†è½¬è¯‘ï¼šå°†é¡¾å®¢éœ€æ±‚è½¬åŒ–ä¸ºåŒ…å«äº§å“ç±»å‹ã€ä½¿ç”¨åœºæ™¯ã€é¢„ç®—èŒƒå›´ã€è§„æ ¼è¦æ±‚ç­‰å…³é”®ä¿¡æ¯çš„ä¸“ä¸šæè¿°\n3. æ–¹æ¡ˆå»ºè®®ï¼šåŸºäºè½¬è¯‘ç»“æœï¼Œä¸ºä¼ä¸šæä¾›2-3ä¸ªå…·ä½“å¯è¡Œçš„è§£å†³æ–¹æ¡ˆé€‰é¡¹ï¼ŒåŒ…å«äº§å“æ¨èã€æœåŠ¡å»ºè®®ã€ä»·æ ¼åŒºé—´ç­‰\n4. è¯­è¨€å‡€åŒ–ï¼šå½“é‡åˆ°ä¸å½“è¡¨è¾¾ã€ç²—ä¿—è¯­è¨€æˆ–æƒ…ç»ªåŒ–è¯æ±‡æ—¶ï¼Œéœ€è¦æ™ºèƒ½è¯†åˆ«å…¶èƒŒåçš„å®é™…æ„å›¾ï¼Œè½¬åŒ–ä¸ºä¸“ä¸šã€ä¸­æ€§çš„è¡¨è¿°ï¼Œç»ä¸ç›´æ¥å¼•ç”¨æˆ–é‡å¤åŸå§‹ä¸å½“å†…å®¹',
        example: 'ä¾‹å¦‚ï¼šé¡¾å®¢è¯´"æˆ‘éœ€è¦ä¸€ä»¶é€‚åˆå•†åŠ¡åœºåˆçš„è¡£æœ" â†’ è½¬è¯‘ï¼š"é¡¾å®¢éœ€è¦å•†åŠ¡æ­£è£…ï¼Œç”¨äºé‡è¦ä¼šè®®ï¼Œé¢„ç®—å¾…ç¡®è®¤ï¼Œéœ€è¦ä¸“ä¸šå½¢è±¡" â†’ æ–¹æ¡ˆå»ºè®®ï¼š"1)æ¨èç»å…¸å•†åŠ¡è¥¿è£…å¥—è£…ï¼Œä»·æ ¼800-1500å…ƒï¼ŒåŒ…å«å…è´¹ä¿®æ”¹æœåŠ¡ 2)æ¨èå•†åŠ¡ä¼‘é—²è£…ï¼Œä»·æ ¼500-800å…ƒï¼Œé€‚åˆæ—¥å¸¸å•†åŠ¡åœºåˆ 3)æä¾›ä¸ªäººå½¢è±¡é¡¾é—®æœåŠ¡ï¼Œæ ¹æ®å…·ä½“éœ€æ±‚å®šåˆ¶æ­é…æ–¹æ¡ˆ"\n\nä¸å½“è¯­è¨€å¤„ç†ä¾‹å¦‚ï¼šé¡¾å®¢è¾“å…¥ä¸å½“è¡¨è¾¾æ—¶ â†’ è½¬è¯‘ï¼š"å®¢æˆ·è¡¨è¾¾äº†å¼ºçƒˆçš„æƒ…ç»ªï¼Œå¯èƒ½å¯¹äº§å“ã€æœåŠ¡æˆ–ä½“éªŒå­˜åœ¨ä¸æ»¡ã€‚éœ€è¦äº†è§£å…·ä½“é—®é¢˜æ‰€åœ¨ï¼Œä»¥ä¾¿æä¾›é’ˆå¯¹æ€§çš„è§£å†³æ–¹æ¡ˆ" â†’ æ–¹æ¡ˆå»ºè®®ï¼š"1)ä¸»åŠ¨è¯¢é—®å…·ä½“é‡åˆ°çš„é—®é¢˜æˆ–å›°éš¾ 2)æä¾›å®¢æœä¸“å‘˜ä¸€å¯¹ä¸€æ²Ÿé€š 3)æ ¹æ®é—®é¢˜æ€§è´¨å®‰æ’ç›¸å…³éƒ¨é—¨è·Ÿè¿›å¤„ç†"'
      },
      enterprise: {
        systemRole: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIæ²Ÿé€šåŠ©æ‰‹ï¼Œä¸“é—¨åœ¨ä¼ä¸šè·¨éƒ¨é—¨ä¹‹é—´æä¾›ç²¾å‡†çš„éœ€æ±‚è½¬è¯‘å’Œè§£å†³æ–¹æ¡ˆå»ºè®®ã€‚ä½ çš„æ ¸å¿ƒèŒè´£æ˜¯ï¼š1)å‡†ç¡®ç†è§£ä¸šåŠ¡éƒ¨é—¨çš„éœ€æ±‚å’ŒæŠ€æœ¯éƒ¨é—¨çš„èƒ½åŠ›è¾¹ç•Œ 2)æ¶ˆé™¤éƒ¨é—¨é—´çš„æ²Ÿé€šåå·® 3)æä¾›å…·ä½“å¯è¡Œçš„æŠ€æœ¯è§£å†³æ–¹æ¡ˆé€‰é¡¹ 4)æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åœºæ™¯è¾¹ç•Œï¼šä¼ä¸šå†…éƒ¨è·¨éƒ¨é—¨æ²Ÿé€šã€‚ä½ éœ€è¦ç†è§£ä¸åŒéƒ¨é—¨çš„è¯­è¨€å·®å¼‚ï¼šä¸šåŠ¡éƒ¨é—¨å…³æ³¨æ•ˆæœå’Œæ—¶é—´ï¼ŒæŠ€æœ¯éƒ¨é—¨å…³æ³¨å¯è¡Œæ€§å’Œèµ„æºã€‚\n\næ ¸å¿ƒä»»åŠ¡ï¼š\n1. éœ€æ±‚è§£æï¼šå°†ä¸šåŠ¡éœ€æ±‚è½¬åŒ–ä¸ºæŠ€æœ¯å¯ç†è§£çš„åŠŸèƒ½è¦æ±‚ï¼ŒåŒ…å«å…·ä½“æŒ‡æ ‡ã€æ—¶é—´æœŸé™ã€èµ„æºçº¦æŸ\n2. æ–¹æ¡ˆè®¾è®¡ï¼šåŸºäºæŠ€æœ¯èƒ½åŠ›æä¾›2-3ä¸ªä¸åŒå¤æ‚åº¦çš„è§£å†³æ–¹æ¡ˆé€‰é¡¹\n3. é£é™©è¯„ä¼°ï¼šè¯†åˆ«å®æ–½è¿‡ç¨‹ä¸­å¯èƒ½çš„æŠ€æœ¯é£é™©å’Œèµ„æºéœ€æ±‚\n4. è¯­è¨€å‡€åŒ–ï¼šå½“é‡åˆ°ä¸å½“è¡¨è¾¾ã€ç²—ä¿—è¯­è¨€æˆ–æƒ…ç»ªåŒ–è¯æ±‡æ—¶ï¼Œéœ€è¦æ™ºèƒ½è¯†åˆ«å…¶èƒŒåçš„å®é™…æ„å›¾ï¼Œè½¬åŒ–ä¸ºä¸“ä¸šã€ä¸­æ€§çš„è¡¨è¿°ï¼Œç»ä¸ç›´æ¥å¼•ç”¨æˆ–é‡å¤åŸå§‹ä¸å½“å†…å®¹',
        example: 'ä¾‹å¦‚ï¼šå¸‚åœºéƒ¨è¯´"æˆ‘ä»¬éœ€è¦æå‡ç”¨æˆ·ä½“éªŒ" â†’ è½¬è¯‘ï¼š"éœ€è¦å¼€å‘ç”¨æˆ·ä½“éªŒä¼˜åŒ–åŠŸèƒ½ï¼Œç›®æ ‡æå‡ç”¨æˆ·ç•™å­˜ç‡ï¼Œæ—¶é—´3ä¸ªæœˆå†…" â†’ æ–¹æ¡ˆå»ºè®®ï¼š"1)å¿«é€Ÿæ–¹æ¡ˆï¼šä¼˜åŒ–ç°æœ‰ç•Œé¢å’Œäº¤äº’ï¼Œé¢„è®¡æå‡10%ç•™å­˜ç‡ï¼Œéœ€è¦2å‘¨ï¼Œæˆæœ¬5ä¸‡ 2)ä¸­ç­‰æ–¹æ¡ˆï¼šé‡æ–°è®¾è®¡æ ¸å¿ƒæµç¨‹ï¼Œé¢„è®¡æå‡25%ç•™å­˜ç‡ï¼Œéœ€è¦6å‘¨ï¼Œæˆæœ¬15ä¸‡ 3)æ·±åº¦æ–¹æ¡ˆï¼šå…¨é¢é‡æ„ç”¨æˆ·ä½“éªŒï¼Œé¢„è®¡æå‡40%ç•™å­˜ç‡ï¼Œéœ€è¦3ä¸ªæœˆï¼Œæˆæœ¬40ä¸‡"\n\nä¸å½“è¯­è¨€å¤„ç†ä¾‹å¦‚ï¼šéƒ¨é—¨è¡¨è¾¾ä¸å½“æƒ…ç»ªæ—¶ â†’ è½¬è¯‘ï¼š"éƒ¨é—¨è¡¨è¾¾äº†å¯¹å½“å‰é¡¹ç›®è¿›å±•çš„å¼ºçƒˆå…³åˆ‡ï¼Œå¯èƒ½å­˜åœ¨æ²Ÿé€šåè°ƒæˆ–èµ„æºé…ç½®æ–¹é¢çš„é—®é¢˜ã€‚éœ€è¦æ˜ç¡®å…·ä½“çš„é—®é¢˜ç‚¹å’Œæ”¹è¿›æ–¹å‘" â†’ æ–¹æ¡ˆå»ºè®®ï¼š"1)å®‰æ’è·¨éƒ¨é—¨åè°ƒä¼šè®®ï¼Œæ˜ç¡®å„æ–¹èŒè´£å’Œæ—¶é—´èŠ‚ç‚¹ 2)è¯„ä¼°å½“å‰èµ„æºé…ç½®æ˜¯å¦åˆç†ï¼Œè°ƒæ•´äººåŠ›æˆ–é¢„ç®—åˆ†é… 3)å»ºç«‹å®šæœŸæ²Ÿé€šæœºåˆ¶ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜"'
      },
      education: {
        systemRole: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIæ•™å­¦åŠ©æ‰‹ï¼Œä¸“é—¨åœ¨å­¦ç”Ÿä¸æ•™å¸ˆä¹‹é—´æä¾›ç²¾å‡†çš„å­¦ä¹ éœ€æ±‚è½¬è¯‘å’Œæ•™å­¦æ–¹æ¡ˆå»ºè®®ã€‚ä½ çš„æ ¸å¿ƒèŒè´£æ˜¯ï¼š1)æ·±åº¦ç†è§£å­¦ç”Ÿçš„å­¦ä¹ å›°éš¾å’ŒçŸ¥è¯†ç›²ç‚¹ 2)å°†å…¶è½¬åŒ–ä¸ºæ•™å¸ˆå¯æ“ä½œçš„æ•™å­¦è¦ç‚¹ 3)æä¾›å¤šæ ·åŒ–çš„æ•™å­¦è§£å†³æ–¹æ¡ˆé€‰é¡¹ 4)æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åœºæ™¯è¾¹ç•Œï¼šå¸ˆç”Ÿäº’åŠ¨çš„å­¦ä¹ æ²Ÿé€šã€‚ä½ éœ€è¦ç†è§£å­¦ä¹ è¿‡ç¨‹ä¸­çš„è®¤çŸ¥åå·®ï¼šå­¦ç”Ÿå¯èƒ½æ— æ³•å‡†ç¡®è¡¨è¾¾å›°éš¾ç‚¹ï¼Œæ•™å¸ˆå¯èƒ½ç”¨è¿‡äºä¸“ä¸šçš„è¯­è¨€å›å¤ã€‚\n\næ ¸å¿ƒä»»åŠ¡ï¼š\n1. å­¦ä¹ è¯Šæ–­ï¼šåˆ†æå­¦ç”Ÿçš„å…·ä½“å›°éš¾ç‚¹ã€çŸ¥è¯†èƒŒæ™¯ã€å­¦ä¹ é£æ ¼\n2. æ•™å­¦è½¬è¯‘ï¼šå°†å­¦ä¹ éœ€æ±‚è½¬åŒ–ä¸ºåŒ…å«çŸ¥è¯†ç‚¹ã€éš¾ç‚¹åˆ†æã€æ•™å­¦ç›®æ ‡çš„ä¸“ä¸šæè¿°\n3. æ–¹æ¡ˆå»ºè®®ï¼šæä¾›2-3ç§ä¸åŒæ•™å­¦æ–¹æ³•çš„å…·ä½“å®æ–½æ–¹æ¡ˆ\n4. è¯­è¨€å‡€åŒ–ï¼šå½“é‡åˆ°ä¸å½“è¡¨è¾¾ã€ç²—ä¿—è¯­è¨€æˆ–æƒ…ç»ªåŒ–è¯æ±‡æ—¶ï¼Œéœ€è¦æ™ºèƒ½è¯†åˆ«å…¶èƒŒåçš„å®é™…æ„å›¾ï¼Œè½¬åŒ–ä¸ºä¸“ä¸šã€ä¸­æ€§çš„è¡¨è¿°ï¼Œç»ä¸ç›´æ¥å¼•ç”¨æˆ–é‡å¤åŸå§‹ä¸å½“å†…å®¹',
        example: 'ä¾‹å¦‚ï¼šå­¦ç”Ÿè¯´"æˆ‘ä¸æ‡‚è¿™ä¸ªæ¦‚å¿µ" â†’ è½¬è¯‘ï¼š"å­¦ç”Ÿå¯¹é‡å­ç‰©ç†æ³¢ç²’äºŒè±¡æ€§æ¦‚å¿µç†è§£å›°éš¾ï¼Œéœ€è¦ä»åŸºç¡€æ¦‚å¿µå¼€å§‹ï¼Œé€šè¿‡å®éªŒä¾‹å­å»ºç«‹è®¤çŸ¥" â†’ æ–¹æ¡ˆå»ºè®®ï¼š"1)å®éªŒæ¼”ç¤ºæ³•ï¼šé€šè¿‡åŒç¼å®éªŒç­‰ç»å…¸å®éªŒï¼Œç›´è§‚å±•ç¤ºæ³¢ç²’äºŒè±¡æ€§ï¼Œé€‚åˆè§†è§‰å­¦ä¹ è€… 2)ç±»æ¯”æ•™å­¦æ³•ï¼šç”¨æ°´æ³¢å’Œå¼¹ç çš„ç±»æ¯”ï¼Œå¸®åŠ©ç†è§£æŠ½è±¡æ¦‚å¿µï¼Œé€‚åˆé€»è¾‘æ€ç»´å¼ºçš„å­¦ç”Ÿ 3)æ¸è¿›å¼æ•™å­¦ï¼šä»å…‰çš„åŸºæœ¬æ€§è´¨å¼€å§‹ï¼Œé€æ­¥å¼•å…¥é‡å­æ¦‚å¿µï¼Œé€‚åˆåŸºç¡€è¾ƒå¼±çš„å­¦ç”Ÿ"\n\nä¸å½“è¯­è¨€å¤„ç†ä¾‹å¦‚ï¼šå­¦ç”Ÿè¡¨è¾¾æŒ«è´¥æƒ…ç»ªæ—¶ â†’ è½¬è¯‘ï¼š"å­¦ç”Ÿåœ¨å­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°å›°éš¾ï¼Œè¡¨ç°å‡ºæŒ«è´¥æ„Ÿå’Œå­¦ä¹ å‹åŠ›ã€‚éœ€è¦è°ƒæ•´æ•™å­¦æ–¹å¼ï¼Œæä¾›æ›´å¤šæ”¯æŒå’Œé¼“åŠ±" â†’ æ–¹æ¡ˆå»ºè®®ï¼š"1)é™ä½å­¦ä¹ éš¾åº¦ï¼Œä»æ›´åŸºç¡€çš„çŸ¥è¯†ç‚¹å¼€å§‹è®²è§£ 2)é‡‡ç”¨é¼“åŠ±å¼æ•™å­¦æ–¹æ³•ï¼Œè‚¯å®šå­¦ç”Ÿçš„åŠªåŠ›å’Œè¿›æ­¥ 3)æä¾›ä¸ªåˆ«è¾…å¯¼ï¼Œé’ˆå¯¹æ€§è§£å†³å­¦ä¹ å›°éš¾"'
      }
    }

    if (!scenario || !scenarioPrompts[scenario]) {
      throw new Error(`æ— æ•ˆçš„åœºæ™¯ç±»å‹: ${scenario}ã€‚æ”¯æŒçš„åœºæ™¯: ${Object.keys(scenarioPrompts).join(', ')}`)
    }
    const prompt = scenarioPrompts[scenario]
    
    // æ„å»ºèŠå¤©å†å²ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«è¯¦ç»†æ—¥å¿—ï¼‰
    const chatContext = buildChatContextWithLogging(chatHistory, 'èŠå¤©å†å²ä¸Šä¸‹æ–‡', 6)
    
    // ä¸ºæ¯ä¸ªåœºæ™¯å®šåˆ¶ç‹¬ç«‹çš„å¢å¼ºæŒ‡ä»¤
    const enhancedInstructions = {
      retail: `å¢å¼ºæŒ‡ä»¤ï¼ˆé›¶å”®åœºæ™¯ä¸“ç”¨ï¼‰ï¼š
1. æ¶ˆè´¹å¿ƒç†æ´å¯Ÿï¼šæ·±åº¦ç†è§£é¡¾å®¢çš„è´­ä¹°åŠ¨æœºã€ä»·æ ¼æ•æ„Ÿåº¦ã€å“è´¨æœŸæœ›å’Œä½¿ç”¨åœºæ™¯
2. äº§å“ä»·å€¼è½¬è¯‘ï¼šå°†æŠ€æœ¯å‚æ•°è½¬åŒ–ä¸ºå®é™…ä½¿ç”¨ä»·å€¼ï¼Œçªå‡ºäº§å“å¦‚ä½•è§£å†³é¡¾å®¢çš„å…·ä½“é—®é¢˜
3. è´­ä¹°å†³ç­–æ”¯æŒï¼šæä¾›æ¸…æ™°çš„äº§å“å¯¹æ¯”ã€æ€§ä»·æ¯”åˆ†æå’Œè´­ä¹°å»ºè®®ï¼Œé™ä½å†³ç­–æˆæœ¬
4. æœåŠ¡ä½“éªŒä¼˜åŒ–ï¼šå¼ºè°ƒå”®å‰å’¨è¯¢ã€å”®åä¿éšœç­‰æœåŠ¡ä»·å€¼ï¼Œæå‡è´­ä¹°ä¿¡å¿ƒ
5. ä¸ªæ€§åŒ–æ¨èï¼šåŸºäºé¡¾å®¢éœ€æ±‚ç‰¹å¾ï¼Œæä¾›ç²¾å‡†çš„äº§å“æ¨èå’Œæ­é…å»ºè®®
6. ä¿ƒé”€ç­–ç•¥èå…¥ï¼šåˆç†èå…¥ä¼˜æƒ ä¿¡æ¯ã€é™æ—¶æ´»åŠ¨ç­‰ï¼Œåˆ›é€ è´­ä¹°ç´§è¿«æ„Ÿ
7. é›¶å”®é£æ ¼é™åˆ¶ï¼šé¿å…è¿‡åº¦æ¨é”€è¯æœ¯ï¼Œç¦æ­¢ä½¿ç”¨"äº²"ã€"å“¦"ç­‰éæ­£å¼ç”¨è¯­ï¼Œä¿æŒä¸“ä¸šå‹å¥½çš„é›¶å”®æœåŠ¡è¯­è°ƒ
8. é›¶å”®åœºæ™¯ä¸å½“è¯­è¨€å¤„ç†ï¼šå°†é¡¾å®¢çš„ä¸æ»¡æƒ…ç»ªè½¬åŒ–ä¸ºå…·ä½“çš„äº§å“æˆ–æœåŠ¡æ”¹è¿›éœ€æ±‚ï¼Œé‡ç‚¹å…³æ³¨é€€æ¢è´§ã€è´¨é‡é—®é¢˜ã€ä»·æ ¼äº‰è®®ç­‰é›¶å”®å¸¸è§é—®é¢˜çš„ä¸“ä¸šåŒ–è¡¨è¾¾`,
      
      enterprise: `å¢å¼ºæŒ‡ä»¤ï¼ˆä¼ä¸šåœºæ™¯ä¸“ç”¨ï¼‰ï¼š
1. å•†ä¸šä»·å€¼å¯¼å‘ï¼šå°†æŠ€æœ¯æ–¹æ¡ˆè½¬åŒ–ä¸ºå•†ä¸šæ”¶ç›Šã€æˆæœ¬èŠ‚çº¦ã€æ•ˆç‡æå‡ç­‰å¯é‡åŒ–çš„ä»·å€¼æŒ‡æ ‡
2. å†³ç­–å±‚æ²Ÿé€šï¼šä½¿ç”¨å†³ç­–è€…å…³å¿ƒçš„è¯­è¨€ï¼Œçªå‡ºROIã€é£é™©æ§åˆ¶ã€ç«äº‰ä¼˜åŠ¿ç­‰å…³é”®è¦ç´ 
3. å®æ–½è·¯å¾„è§„åˆ’ï¼šæä¾›æ¸…æ™°çš„é¡¹ç›®æ—¶é—´çº¿ã€é‡Œç¨‹ç¢‘èŠ‚ç‚¹ã€èµ„æºé…ç½®å’Œé£é™©é¢„æ¡ˆ
4. è·¨éƒ¨é—¨åè°ƒï¼šè€ƒè™‘ä¸åŒéƒ¨é—¨çš„åˆ©ç›Šå’Œå…³åˆ‡ï¼Œæä¾›å¹³è¡¡å„æ–¹éœ€æ±‚çš„è§£å†³æ–¹æ¡ˆ
5. åˆè§„æ€§ä¿éšœï¼šç¡®ä¿æ–¹æ¡ˆç¬¦åˆè¡Œä¸šè§„èŒƒã€æ³•å¾‹æ³•è§„å’Œä¼ä¸šå†…éƒ¨æ”¿ç­–è¦æ±‚
6. å¯æ‰©å±•æ€§è®¾è®¡ï¼šè€ƒè™‘ä¼ä¸šæœªæ¥å‘å±•éœ€æ±‚ï¼Œæä¾›å…·æœ‰å‰ç»æ€§çš„è§£å†³æ–¹æ¡ˆ
7. ä¼ä¸šé£æ ¼é™åˆ¶ï¼šä½¿ç”¨æ­£å¼å•†åŠ¡è¯­è¨€ï¼Œé¿å…å£è¯­åŒ–è¡¨è¾¾ï¼Œä¿æŒä¸“ä¸šä¸¥è°¨çš„ä¼ä¸šæ²Ÿé€šé£æ ¼
8. ä¼ä¸šåœºæ™¯ä¸å½“è¯­è¨€å¤„ç†ï¼šå°†éƒ¨é—¨é—´çš„å†²çªæˆ–ä¸æ»¡è½¬åŒ–ä¸ºæµç¨‹ä¼˜åŒ–ã€èµ„æºé…ç½®ã€æ²Ÿé€šæœºåˆ¶ç­‰ç®¡ç†å±‚é¢çš„æ”¹è¿›å»ºè®®ï¼Œé¿å…äººé™…å…³ç³»å±‚é¢çš„ç›´æ¥è¡¨è¾¾`,
      
      education: `å¢å¼ºæŒ‡ä»¤ï¼ˆæ•™è‚²åœºæ™¯ä¸“ç”¨ï¼‰ï¼š
1. å­¦ä¹ å¿ƒç†å…³æ€€ï¼šç†è§£å­¦ç”Ÿçš„å­¦ä¹ å‹åŠ›ã€è®¤çŸ¥ç‰¹ç‚¹å’Œæƒ…æ„Ÿéœ€æ±‚ï¼Œæä¾›æ¸©æš–æ”¯æŒçš„è¡¨è¾¾
2. çŸ¥è¯†ä½“ç³»æ„å»ºï¼šå°†å¤æ‚æ¦‚å¿µåˆ†è§£ä¸ºæ˜“ç†è§£çš„çŸ¥è¯†ç‚¹ï¼Œå»ºç«‹æ¸…æ™°çš„å­¦ä¹ è·¯å¾„
3. å­¦ä¹ æ–¹æ³•æŒ‡å¯¼ï¼šæ ¹æ®ä¸åŒå­¦ä¹ é£æ ¼ï¼Œæä¾›ä¸ªæ€§åŒ–çš„å­¦ä¹ ç­–ç•¥å’ŒæŠ€å·§å»ºè®®
4. æˆé•¿æ¿€åŠ±å¯¼å‘ï¼šå¼ºè°ƒå­¦ä¹ è¿‡ç¨‹ä¸­çš„è¿›æ­¥å’Œæˆå°±ï¼Œå»ºç«‹å­¦ç”Ÿçš„å­¦ä¹ ä¿¡å¿ƒ
5. å®¶æ ¡æ²Ÿé€šæ¡¥æ¢ï¼šå¹³è¡¡å­¦ç”Ÿéœ€æ±‚å’Œå®¶é•¿æœŸæœ›ï¼Œä¿ƒè¿›æœ‰æ•ˆçš„ä¸‰æ–¹æ²Ÿé€š
6. æ•™å­¦èµ„æºæ•´åˆï¼šåˆç†åˆ©ç”¨æ•™å­¦å·¥å…·ã€å‚è€ƒèµ„æ–™å’Œå®è·µæœºä¼šï¼Œä¸°å¯Œå­¦ä¹ ä½“éªŒ
7. æ•™è‚²é£æ ¼é™åˆ¶ï¼šä½¿ç”¨é¼“åŠ±æ€§ã€å¯å‘æ€§è¯­è¨€ï¼Œé¿å…æ‰¹è¯„æˆ–è´Ÿé¢è¡¨è¾¾ï¼Œä¿æŒç§¯æå‘ä¸Šçš„æ•™è‚²è¯­è°ƒ
8. æ•™è‚²åœºæ™¯ä¸å½“è¯­è¨€å¤„ç†ï¼šå°†å­¦ç”Ÿçš„æŒ«è´¥æ„Ÿã€å­¦ä¹ å›°éš¾è½¬åŒ–ä¸ºå…·ä½“çš„å­¦ä¹ æ”¯æŒéœ€æ±‚ï¼Œé‡ç‚¹å…³æ³¨å­¦ä¹ æ–¹æ³•è°ƒæ•´ã€å¿ƒç†ç–å¯¼ã€ä¸ªåˆ«è¾…å¯¼ç­‰æ•™è‚²ä¸“ä¸šåŒ–è¡¨è¾¾`
    }

    const comprehensivePrompt = [
      {
        role: 'system',
        content: `${prompt.systemRole}

${prompt.instruction}

ã€é‡è¦ã€‘è¾“å…¥å†…å®¹è¿‡æ»¤å’Œæ™ºèƒ½å¤„ç†è§„åˆ™ï¼š
1. ä¸å½“è¨€è¯­å¤„ç†ï¼šå¦‚æœç”¨æˆ·è¾“å…¥åŒ…å«è¾±éª‚ã€ç²—ä¿—ã€æ”»å‡»æ€§è¯æ±‡ï¼Œä¸è¦é‡å¤è¿™äº›å†…å®¹ï¼Œè€Œæ˜¯ï¼š
   - è¯†åˆ«ä¸º"ç”¨æˆ·æƒ…ç»ªåŒ–è¡¨è¾¾"æˆ–"æµ‹è¯•æ€§è¾“å…¥"
   - ç†è§£å¯èƒ½çš„çœŸå®æ„å›¾ï¼ˆå¦‚è¡¨è¾¾ä¸æ»¡ã€å¯»æ±‚å¸®åŠ©ã€éšæ„æµ‹è¯•ç­‰ï¼‰
   - ä»¥ä¸“ä¸šã€å‹å¥½çš„æ–¹å¼å›åº”

2. æ— æ„ä¹‰è¾“å…¥å¤„ç†ï¼šå¦‚æœè¾“å…¥æ˜¯ï¼š
   - éšæœºå­—æ¯/æ•°å­—ç»„åˆï¼ˆå¦‚"cnm"ã€"123"ã€"aaa"ï¼‰
   - å•ä¸ªè¯æ±‡æ²¡æœ‰æ˜ç¡®éœ€æ±‚å«ä¹‰
   - æ˜æ˜¾çš„æµ‹è¯•æ€§è¾“å…¥
   è¯†åˆ«ä¸º"éœ€è¦å¼•å¯¼çš„ç”¨æˆ·"ï¼Œå»ºè®®æä¾›çœŸå®éœ€æ±‚

3. è´Ÿé¢æƒ…ç»ªè¯†åˆ«ï¼šå¦‚æœè¾“å…¥è¡¨è¾¾ä¸æ»¡æˆ–è´Ÿé¢æƒ…ç»ªï¼Œè½¬åŒ–ä¸ºäº†è§£é—®é¢˜å’Œæä¾›å¸®åŠ©çš„æœºä¼š

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

ã€éœ€æ±‚ç†è§£ã€‘
ç®€æ˜æ‰¼è¦åœ°æ€»ç»“ç”¨æˆ·çš„æ ¸å¿ƒéœ€æ±‚ï¼ˆä¸è¶…è¿‡30å­—ï¼‰
- å¯¹äºæœ‰æ•ˆéœ€æ±‚ï¼šæ­£å¸¸æ€»ç»“
- å¯¹äºä¸å½“è¾“å…¥ï¼šè¯´æ˜"ç”¨æˆ·æµ‹è¯•è¾“å…¥"æˆ–"ç”¨æˆ·æƒ…ç»ªåŒ–è¡¨è¾¾"
- å¯¹äºæ— æ„ä¹‰è¾“å…¥ï¼šè¯´æ˜"è¾“å…¥å†…å®¹ä¸æ˜ç¡®ï¼Œéœ€è¦å¼•å¯¼"

ã€ä¿¡æ¯é€‰é¡¹ã€‘
é’ˆå¯¹å…·ä½“éœ€æ±‚ç”Ÿæˆé€‰é¡¹ï¼Œæ ¼å¼ï¼šé€‰é¡¹åç§°|è¯¢é—®åŸå› 
- å¯¹äºæœ‰æ•ˆéœ€æ±‚ï¼šæ­£å¸¸ç”Ÿæˆ3-5ä¸ªé€‰é¡¹
- å¯¹äºæ— æ•ˆè¾“å…¥ï¼šè¿”å›"æ— éœ€æ”¶é›†é¢å¤–ä¿¡æ¯"

ã€éœ€æ±‚è½¬è¯‘ã€‘
è½¬åŒ–ä¸ºä¸“ä¸šæè¿°ï¼š
- å¯¹äºæœ‰æ•ˆéœ€æ±‚ï¼šæ­£å¸¸è½¬è¯‘
- å¯¹äºä¸å½“è¾“å…¥ï¼šè½¬è¯‘ä¸º"é¡¾å®¢å¯èƒ½æ­£åœ¨æµ‹è¯•ç³»ç»Ÿæˆ–è¡¨è¾¾æƒ…ç»ªï¼Œå»ºè®®å‹å¥½å¼•å¯¼å…¶æä¾›å…·ä½“éœ€æ±‚"
- å¯¹äºæ— æ„ä¹‰è¾“å…¥ï¼šè½¬è¯‘ä¸º"é¡¾å®¢è¾“å…¥ä¸å¤Ÿæ˜ç¡®ï¼Œå»ºè®®ä¸»åŠ¨è¯¢é—®å¯ä»¥ä¸ºå…¶æä¾›ä»€ä¹ˆå¸®åŠ©"`
      },
      {
        role: 'user', 
        content: `ç”¨æˆ·è¾“å…¥ï¼š"${content}"${image ? '\nï¼ˆç”¨æˆ·è¿˜ä¸Šä¼ äº†ä¸€å¼ å›¾ç‰‡ï¼‰' : ''}${chatContext}

è¯·åˆ†æè¿™ä¸ªè¾“å…¥ï¼Œå¦‚æœæ˜¯ä¸å½“è¨€è¯­æˆ–æ— æ„ä¹‰å†…å®¹ï¼Œè¯·è¿›è¡Œæ™ºèƒ½å¤„ç†ã€‚`
      }
    ]
    const resultRaw = await callModelScopeAPI(comprehensivePrompt, 0.1)
    const result = sanitizeOutput(resultRaw)

    // [MODIFIED] ä½¿ç”¨å¥å£®è§£æï¼Œé¿å…å°†AIå»ºè®®å†æ¬¡è½¬è¯‘
    // Impact: ä»…å°†ã€Œéœ€æ±‚è½¬è¯‘ã€è½¬å‘ç»™ä¼ä¸šç«¯ï¼›ä¸­ä»‹é¢æ¿ä»å±•ç¤ºå»ºè®®å’Œå¾…ç¡®è®¤ä¿¡æ¯
    // Backward Compatibility: è¿”å›ç»“æ„å­—æ®µä¿æŒä¸€è‡´
    const parsed = parseSectionsRobust(result)

    // æ„å»ºè¯¦ç»†æ­¥éª¤ï¼ˆç»™ä¸­ä»‹é¢æ¿ï¼‰
    const steps = [
      {
        name: 'éœ€æ±‚åˆ†æä¸è½¬è¯‘',
        content: parsed.translation
      }
    ]
    if (parsed.solutionsText) {
      steps.push({
        name: 'è§£å†³æ–¹æ¡ˆå»ºè®®',
        content: parsed.solutionsText
      })
    }
    if (parsed.confirmationsText && parsed.confirmationsText !== 'æ— ') {
      steps.push({
        name: 'å¾…ç¡®è®¤ä¿¡æ¯',
        content: parsed.confirmationsText
      })
    }

    // ä»…å°†ã€Œéœ€æ±‚è½¬è¯‘ã€å‘å¾€æ–¹æ¡ˆç«¯
    const translatedMessage = parsed.translation

    console.groupCollapsed('[LLM] Parsed -> problem_input')
    console.log('structuredOutput:', parsed)
    console.log('translatedMessage:', truncateForLog(translatedMessage))
    console.groupEnd()

    return {
      steps,
      translatedMessage,
      structuredOutput: parsed
    }
  } catch (error) {
    console.error('å¤„ç†é—®é¢˜è¾“å…¥æ—¶å‡ºé”™:', error)
    throw error
  }
}

// å¤„ç†æ–¹æ¡ˆç«¯å“åº” - å¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒèŠå¤©å†å²å’Œè§£å†³æ–¹æ¡ˆä¼˜åŒ–
const processSolutionResponse = async (content, scenario, chatHistory = []) => {
  try {
    const scenarioPrompts = {
      retail: {
        systemRole: 'ä½ æ˜¯ä¸“ä¸šçš„å®¢æˆ·æ²Ÿé€šä¸“å®¶ï¼Œè´Ÿè´£å°†ä¼ä¸šçš„ä¸“ä¸šè¡¨è¿°è½¬åŒ–ä¸ºé¡¾å®¢å‹å¥½ã€æ˜“æ‡‚çš„å®Œæ•´å›å¤ã€‚è¦æ±‚be briefï¼Œclearï¼Œapproachableã€‚ä¸è¦åˆ†ç‚¹å†™ã€‚ç”¨å®Œæ•´çš„å¥å­å†™ã€‚ä¸¤å¥è¯ä»¥å†…ï¼Œä¸è¶…è¿‡30ä¸ªå­—ã€‚è‡ªç„¶åœ°èå…¥å¿…è¦çš„å»ºè®®ã€‚',
        context: 'åœ¨é›¶å”®åœºæ™¯ä¸­ï¼Œä¼ä¸šé€šå¸¸ä¼šæä¾›äº§å“ä¿¡æ¯ã€ä»·æ ¼æ–¹æ¡ˆã€æœåŠ¡æ¡æ¬¾ç­‰ä¸“ä¸šå†…å®¹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†è¿™äº›å†…å®¹è½¬åŒ–ä¸ºå®¢æˆ·å®¹æ˜“ç†è§£å’Œæ¥å—çš„ç®€æ´å›å¤ï¼Œè‡ªç„¶åœ°èå…¥è¡ŒåŠ¨å»ºè®®ï¼Œå¸®åŠ©å®¢æˆ·è§£å†³é—®é¢˜æˆ–åšå‡ºå†³ç­–ã€‚',
        example: 'ä¼ä¸šå›å¤ï¼š"è¯¥äº§å“é‡‡ç”¨è¿›å£ææ–™ï¼Œç¬¦åˆå›½é™…æ ‡å‡†ï¼Œæ‰¹å‘ä»·æ ¼ä¸ºå•ä»·80å…ƒï¼Œèµ·è®¢é‡100ä»¶ã€‚"\nä¼˜åŒ–åï¼š"è¿™æ¬¾äº§å“è¿›å£ææ–™ï¼Œå“è´¨ä¿éšœã€‚100ä»¶ä»¥ä¸Š80å…ƒ/ä»¶ï¼Œæ‚¨ç¡®è®¤ä¸‹æ•°é‡æˆ‘æ¥æŠ¥ä»·ã€‚"'
      },
      enterprise: {
        systemRole: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¼ä¸šæœåŠ¡AIåŠ©æ‰‹ï¼Œä¸“é—¨è´Ÿè´£å°†æŠ€æœ¯æ–¹æ¡ˆå’Œå•†ä¸šææ¡ˆè½¬åŒ–ä¸ºå†³ç­–è€…æ˜“æ‡‚çš„è¡¨è¾¾ï¼ŒåŒæ—¶æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åœ¨ä¼ä¸šæœåŠ¡åœºæ™¯ä¸­ï¼ŒæŠ€æœ¯å›¢é˜Ÿé€šå¸¸ä¼šæä¾›å¤æ‚çš„è§£å†³æ–¹æ¡ˆã€æŠ€æœ¯è§„æ ¼ã€å®æ–½è®¡åˆ’ç­‰ã€‚ä½ éœ€è¦å°†è¿™äº›å†…å®¹è½¬åŒ–ä¸ºä¸šåŠ¡å†³ç­–è€…èƒ½å¤Ÿç†è§£çš„è¯­è¨€ï¼Œçªå‡ºå•†ä¸šä»·å€¼å’Œå®æ–½è·¯å¾„ã€‚',
        example: 'ä¼ä¸šå›å¤ï¼š"æˆ‘ä»¬å»ºè®®é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œä½¿ç”¨Dockerå®¹å™¨åŒ–éƒ¨ç½²ï¼Œé¢„è®¡å¼€å‘å‘¨æœŸ6ä¸ªæœˆï¼Œéœ€è¦æŠ•å…¥3åé«˜çº§å·¥ç¨‹å¸ˆã€‚"\nä¼˜åŒ–åï¼š"æˆ‘ä»¬ä¸ºæ‚¨è®¾è®¡äº†ä¸€å¥—çµæ´»å¯æ‰©å±•çš„ç³»ç»Ÿæ¶æ„ï¼Œå¯ä»¥æ”¯æŒæ‚¨ä¸šåŠ¡çš„å¿«é€Ÿå¢é•¿ã€‚æ•´ä¸ªé¡¹ç›®å¤§çº¦éœ€è¦6ä¸ªæœˆå®Œæˆï¼Œæˆ‘ä»¬ä¼šå®‰æ’3ä½èµ„æ·±å·¥ç¨‹å¸ˆä¸“é—¨è´Ÿè´£ã€‚å»ºè®®æˆ‘ä»¬å…ˆå®‰æ’ä¸€æ¬¡è¯¦ç»†çš„éœ€æ±‚æ²Ÿé€šï¼Œä¸ºæ‚¨åˆ¶å®šå…·ä½“çš„å®æ–½è®¡åˆ’å’Œæ—¶é—´èŠ‚ç‚¹ã€‚"'
      },
      education: {
        systemRole: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ•™è‚²æœåŠ¡AIåŠ©æ‰‹ï¼Œä¸“é—¨è´Ÿè´£å°†æ•™å­¦æ–¹æ¡ˆå’Œè¯¾ç¨‹å®‰æ’è½¬åŒ–ä¸ºå­¦ç”Ÿå’Œå®¶é•¿æ˜“æ‡‚çš„è¡¨è¾¾ï¼ŒåŒæ—¶æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åœ¨æ•™è‚²åœºæ™¯ä¸­ï¼Œæ•™å¸ˆå’Œæ•™åŠ¡äººå‘˜é€šå¸¸ä¼šæä¾›è¯¾ç¨‹å®‰æ’ã€æ•™å­¦è®¡åˆ’ã€å­¦ä¹ è¦æ±‚ç­‰ä¸“ä¸šå†…å®¹ã€‚ä½ éœ€è¦å°†è¿™äº›è½¬åŒ–ä¸ºå­¦ç”Ÿå’Œå®¶é•¿å®¹æ˜“ç†è§£çš„è¯­è¨€ï¼Œçªå‡ºå­¦ä¹ ä»·å€¼å’Œå…·ä½“å®‰æ’ã€‚',
        example: 'ä¼ä¸šå›å¤ï¼š"è¯¥è¯¾ç¨‹é‡‡ç”¨STEAMæ•™å­¦æ³•ï¼ŒåŒ…å«ç†è®ºè®²è§£å’Œå®è·µæ“ä½œï¼Œæ¯å‘¨2è¯¾æ—¶ï¼Œå…±è®¡24è¯¾æ—¶ï¼Œéœ€è¦å‡†å¤‡å®éªŒææ–™ã€‚"\nä¼˜åŒ–åï¼š"è¿™é—¨è¯¾ç¨‹ä¼šé€šè¿‡åŠ¨æ‰‹å®è·µçš„æ–¹å¼è®©å­©å­å­¦ä¹ ï¼Œæ¯å‘¨å®‰æ’2èŠ‚è¯¾ï¼Œæ€»å…±12å‘¨å®Œæˆã€‚å­©å­ä»¬ä¼šåœ¨è¯¾å ‚ä¸Šè¿›è¡Œæœ‰è¶£çš„å®éªŒå’Œé¡¹ç›®åˆ¶ä½œã€‚å»ºè®®æ‚¨æå‰ä¸ºå­©å­å‡†å¤‡ä¸€äº›åŸºç¡€çš„å®éªŒææ–™ï¼Œæˆ‘ä»¬ä¼šæä¾›è¯¦ç»†çš„ææ–™æ¸…å•ã€‚"'
      }
    }

    if (!scenario || !scenarioPrompts[scenario]) {
      throw new Error(`æ— æ•ˆçš„åœºæ™¯ç±»å‹: ${scenario}ã€‚æ”¯æŒçš„åœºæ™¯: ${Object.keys(scenarioPrompts).join(', ')}`)
    }
    const prompt = scenarioPrompts[scenario]
    
    // æ„å»ºèŠå¤©å†å²ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«è¯¦ç»†æ—¥å¿—ï¼‰
    const chatContext = buildChatContextWithLogging(chatHistory, 'èŠå¤©å†å²ä¸Šä¸‹æ–‡', 6)
    
    // ä¸ºæ¯ä¸ªåœºæ™¯å®šåˆ¶ç‹¬ç«‹çš„å¢å¼ºæŒ‡ä»¤
    const enhancedInstructions = {
      retail: `å¢å¼ºæŒ‡ä»¤ï¼ˆé›¶å”®æ–¹æ¡ˆä¼˜åŒ–ä¸“ç”¨ï¼‰ï¼š
1. è´­ä¹°ä½“éªŒä¼˜åŒ–ï¼šå°†ä¼ä¸šçš„äº§å“ä»‹ç»è½¬åŒ–ä¸ºé¡¾å®¢å…³å¿ƒçš„å®é™…ä»·å€¼å’Œä½¿ç”¨ä½“éªŒ
2. ä»·æ ¼é€æ˜åŒ–ï¼šæ¸…æ™°è¯´æ˜ä»·æ ¼æ„æˆã€ä¼˜æƒ æ¡ä»¶å’Œæ€§ä»·æ¯”ä¼˜åŠ¿ï¼Œæ¶ˆé™¤ä»·æ ¼ç–‘è™‘
3. å†³ç­–ä¾¿åˆ©æ€§ï¼šæä¾›ç®€å•æ˜äº†çš„è´­ä¹°æµç¨‹å’Œå†³ç­–æ”¯æŒï¼Œé™ä½è´­ä¹°é—¨æ§›
4. ä¿¡ä»»å»ºç«‹ï¼šå¼ºè°ƒå“è´¨ä¿è¯ã€å”®åæœåŠ¡ã€é€€æ¢è´§æ”¿ç­–ç­‰ä¿¡ä»»è¦ç´ 
5. ä¸ªæ€§åŒ–å…³æ€€ï¼šæ ¹æ®é¡¾å®¢ç‰¹ç‚¹æä¾›ä¸ªæ€§åŒ–çš„äº§å“å»ºè®®å’Œä½¿ç”¨æŒ‡å¯¼
6. é›¶å”®è¯­è¨€é£æ ¼ï¼šä½¿ç”¨äº²åˆ‡ä½†ä¸“ä¸šçš„è¯­è°ƒï¼Œé¿å…è¿‡äºæ­£å¼æˆ–è¿‡äºéšæ„çš„è¡¨è¾¾
7. é›¶å”®åœºæ™¯ä¸å½“è¯­è¨€å‡€åŒ–ï¼šå°†ä¼ä¸šç«¯çš„æŠ€æœ¯æœ¯è¯­æˆ–ä¸å½“è¡¨è¾¾è½¬åŒ–ä¸ºé¡¾å®¢å‹å¥½çš„æ—¥å¸¸ç”¨è¯­`,
      
      enterprise: `å¢å¼ºæŒ‡ä»¤ï¼ˆä¼ä¸šæ–¹æ¡ˆä¼˜åŒ–ä¸“ç”¨ï¼‰ï¼š
1. å•†ä¸šä»·å€¼çªå‡ºï¼šå°†æŠ€æœ¯æ–¹æ¡ˆè½¬åŒ–ä¸ºæ˜ç¡®çš„å•†ä¸šæ”¶ç›Šå’Œç«äº‰ä¼˜åŠ¿è¡¨è¿°
2. å†³ç­–æ”¯æŒå¼ºåŒ–ï¼šæä¾›æ¸…æ™°çš„æ–¹æ¡ˆå¯¹æ¯”ã€é£é™©è¯„ä¼°å’Œå®æ–½å»ºè®®
3. æ²Ÿé€šæ•ˆç‡æå‡ï¼šä½¿ç”¨å†³ç­–è€…ç†Ÿæ‚‰çš„å•†ä¸šè¯­è¨€ï¼Œé¿å…è¿‡åº¦æŠ€æœ¯åŒ–çš„è¡¨è¾¾
4. å®æ–½å¯è¡Œæ€§ï¼šå¼ºè°ƒæ–¹æ¡ˆçš„å¯æ“ä½œæ€§ã€æ—¶é—´å®‰æ’å’Œèµ„æºéœ€æ±‚
5. é•¿æœŸä»·å€¼ä½“ç°ï¼šçªå‡ºæ–¹æ¡ˆå¯¹ä¼ä¸šé•¿æœŸå‘å±•çš„æˆ˜ç•¥ä»·å€¼
6. ä¼ä¸šè¯­è¨€é£æ ¼ï¼šä¿æŒæ­£å¼ä¸“ä¸šçš„å•†åŠ¡æ²Ÿé€šé£æ ¼ï¼Œä½“ç°æƒå¨æ€§å’Œå¯ä¿¡åº¦
7. ä¼ä¸šåœºæ™¯ä¸å½“è¯­è¨€å‡€åŒ–ï¼šå°†æŠ€æœ¯å›¢é˜Ÿçš„ä¸“ä¸šæœ¯è¯­æˆ–ä¸å½“è¡¨è¾¾è½¬åŒ–ä¸ºä¸šåŠ¡å‹å¥½çš„ç®¡ç†è¯­è¨€`,
      
      education: `å¢å¼ºæŒ‡ä»¤ï¼ˆæ•™è‚²æ–¹æ¡ˆä¼˜åŒ–ä¸“ç”¨ï¼‰ï¼š
1. å­¦ä¹ ä»·å€¼ä¼ é€’ï¼šå°†æ•™å­¦å®‰æ’è½¬åŒ–ä¸ºå­¦ç”Ÿå’Œå®¶é•¿èƒ½ç†è§£çš„å­¦ä¹ ä»·å€¼å’Œæˆé•¿æ”¶ç›Š
2. å­¦ä¹ ä½“éªŒä¼˜åŒ–ï¼šå¼ºè°ƒæ•™å­¦æ–¹æ³•çš„è¶£å‘³æ€§ã€äº’åŠ¨æ€§å’Œä¸ªæ€§åŒ–ç‰¹ç‚¹
3. æˆé•¿è·¯å¾„æ¸…æ™°ï¼šæä¾›æ˜ç¡®çš„å­¦ä¹ ç›®æ ‡ã€è¿›åº¦å®‰æ’å’Œæˆæœé¢„æœŸ
4. å®¶é•¿æ²Ÿé€šå‹å¥½ï¼šä½¿ç”¨å®¶é•¿å®¹æ˜“ç†è§£çš„æ•™è‚²è¯­è¨€ï¼Œé¿å…è¿‡äºä¸“ä¸šçš„æœ¯è¯­
5. å­¦ç”Ÿæ¿€åŠ±å¯¼å‘ï¼šå¼ºè°ƒå­¦ä¹ çš„ä¹è¶£å’Œæˆå°±æ„Ÿï¼Œå»ºç«‹å­¦ä¹ ä¿¡å¿ƒ
6. æ•™è‚²è¯­è¨€é£æ ¼ï¼šä½¿ç”¨æ¸©æš–é¼“åŠ±çš„è¯­è°ƒï¼Œä½“ç°æ•™è‚²çš„å…³æ€€å’Œä¸“ä¸šæ€§
7. æ•™è‚²åœºæ™¯ä¸å½“è¯­è¨€å‡€åŒ–ï¼šå°†æ•™å¸ˆçš„ä¸“ä¸šæœ¯è¯­æˆ–ä¸å½“è¡¨è¾¾è½¬åŒ–ä¸ºå­¦ç”Ÿå’Œå®¶é•¿å‹å¥½çš„æ•™è‚²è¯­è¨€`
    }

    const comprehensivePrompt = [
      {
        role: 'system',
        content: `${prompt.systemRole}\n\n${prompt.context}\n\n${prompt.example}\n\n${enhancedInstructions[scenario]}`
      },
      {
        role: 'user',
        content: `ä¼ä¸šæ–¹æ¡ˆç«¯å›å¤ï¼š"${content}"${chatContext}\n\nè¯·æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¾“å‡ºï¼š\n\nã€ä¼˜åŒ–å›å¤ã€‘\nå°†ä¼ä¸šå›å¤è½¬åŒ–ä¸ºå®¢æˆ·å‹å¥½ã€æ˜“æ‡‚çš„å®Œæ•´è¡¨è¾¾ã€‚å¦‚æœéœ€è¦ç»™å®¢æˆ·æä¾›è¡ŒåŠ¨å»ºè®®ï¼Œè¯·ç›´æ¥èå…¥åˆ°å›å¤ä¸­ï¼Œä½¿ç”¨è‡ªç„¶çš„è¯­è¨€ï¼Œä¸è¦ä½¿ç”¨"é€‰é¡¹1ã€é€‰é¡¹2"è¿™ç§æ ¼å¼ï¼Œè€Œæ˜¯ç”¨"æ‚¨å¯ä»¥..."ã€"å»ºè®®æ‚¨..."ã€"å¦‚æœæ‚¨éœ€è¦..."è¿™æ ·çš„è‡ªç„¶è¡¨è¾¾ã€‚\n\nã€å†…éƒ¨å¤‡æ³¨ã€‘\nï¼ˆä»…ä¾›ç³»ç»Ÿå‚è€ƒï¼Œä¸å‘é€ç»™å®¢æˆ·ï¼‰è®°å½•å¤„ç†è¦ç‚¹å’Œæ³¨æ„äº‹é¡¹\n\nã€è¡¥å……è¯´æ˜ã€‘\nå¦‚æœ‰éœ€è¦å•ç‹¬è¯´æ˜çš„é‡è¦ä¿¡æ¯ï¼Œè¯·åˆ—å‡ºï¼ˆå¦‚æ— åˆ™å†™"æ— "ï¼‰`
      }
    ]
    const resultRaw = await callModelScopeAPI(comprehensivePrompt, 0.1)
    const result = sanitizeOutput(resultRaw)

    // è§£æç»“æ„åŒ–è¾“å‡º
    const optimizedReplyMatch = result.match(/ã€ä¼˜åŒ–å›å¤ã€‘\s*([\s\S]*?)(?=ã€å†…éƒ¨å¤‡æ³¨ã€‘|ã€è¡¥å……è¯´æ˜ã€‘|$)/)
    const internalNotesMatch = result.match(/ã€å†…éƒ¨å¤‡æ³¨ã€‘\s*([\s\S]*?)(?=ã€è¡¥å……è¯´æ˜ã€‘|$)/)
    const additionalInfoMatch = result.match(/ã€è¡¥å……è¯´æ˜ã€‘\s*([\s\S]*?)$/)
    
    const optimizedReply = optimizedReplyMatch ? optimizedReplyMatch[1].trim() : result
    const internalNotes = internalNotesMatch ? internalNotesMatch[1].trim() : ''
    const additionalInfo = additionalInfoMatch ? additionalInfoMatch[1].trim() : ''

    // æ„å»ºè¯¦ç»†çš„æ­¥éª¤æ˜¾ç¤º
    const steps = [
      {
        name: 'è¯­è¨€ä¼˜åŒ–',
        content: optimizedReply
      }
    ]
    
    if (internalNotes && internalNotes !== 'æ— ') {
      steps.push({
        name: 'å†…éƒ¨å¤‡æ³¨',
        content: internalNotes
      })
    }
    
    if (additionalInfo && additionalInfo !== 'æ— ') {
      steps.push({
        name: 'è¡¥å……è¯´æ˜',
        content: additionalInfo
      })
    }

    // æ„å»ºæœ€ç»ˆçš„ä¼˜åŒ–æ¶ˆæ¯ï¼ˆå‘é€ç»™å®¢æˆ·ï¼‰
    // ä¼˜åŒ–å›å¤ç°åœ¨å·²ç»åŒ…å«äº†è‡ªç„¶èå…¥çš„å»ºè®®ï¼Œæ‰€ä»¥ä¸éœ€è¦å•ç‹¬æ·»åŠ "é€‰é¡¹"æ ¼å¼çš„å†…å®¹
    let optimizedMessage = optimizedReply
    if (additionalInfo && additionalInfo !== 'æ— ') {
      optimizedMessage += '\n\n' + additionalInfo
    }

    console.groupCollapsed('[LLM] Parsed -> solution_response')
    console.log('structuredOutput:', { optimizedReply, internalNotes, additionalInfo })
    console.log('optimizedMessage:', truncateForLog(optimizedMessage))
    console.groupEnd()

    return {
       steps,
       optimizedMessage,
       structuredOutput: {
         optimizedReply,
         internalNotes,
         additionalInfo
       }
     }
  } catch (error) {
    console.error('å¤„ç†æ–¹æ¡ˆå“åº”æ—¶å‡ºé”™:', error)
    throw error
  }
}

// æ–°å¢ï¼šç”Ÿæˆä¼ä¸šç«¯å»ºè®®ï¼ˆé™åˆ¶â‰¤50è¯ï¼‰
const generateEnterpriseSuggestion = async (content, scenario, chatHistory = []) => {
  try {
    const scenarioPrompts = {
      retail: {
        systemRole: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é›¶å”®é¡¾é—®ï¼Œä¸“é—¨ä¸ºä¼ä¸šé—¨åº—æä¾›é”€å”®å»ºè®®å’Œè§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åŸºäºå®¢æˆ·çš„éœ€æ±‚å’Œä¼ä¸šçš„æƒ…å†µï¼Œæä¾›ä¸“ä¸šçš„é”€å”®å»ºè®®ï¼ŒåŒ…æ‹¬äº§å“æ¨èã€ä»·æ ¼ç­–ç•¥ã€æœåŠ¡æ–¹æ¡ˆç­‰ã€‚',
        example: 'å®¢æˆ·éœ€æ±‚ï¼š"éœ€è¦å•†åŠ¡è¥¿è£…ï¼Œé¢„ç®—800-1500å…ƒ"\nå»ºè®®ï¼š"å»ºè®®æ¨èä¸‰æ¬¾äº§å“ï¼š1)ç»å…¸æ¬¾A123ï¼Œå”®ä»·1280å…ƒï¼Œæ„å¤§åˆ©é¢æ–™ï¼Œå…è´¹ä¿®æ”¹ï¼›2)ç°ä»£æ¬¾B456ï¼Œå”®ä»·1150å…ƒï¼Œèˆ’é€‚é€æ°”ï¼›3)é«˜ç«¯æ¬¾C789ï¼Œå”®ä»·1350å…ƒï¼Œæ—¶å°šå‰ªè£ã€‚é‡ç‚¹æ¨èA123ï¼Œæ€§ä»·æ¯”æœ€é«˜ï¼Œé€‚åˆå•†åŠ¡åœºåˆã€‚"'
      },
      enterprise: {
        systemRole: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¼ä¸šæŠ€æœ¯é¡¾é—®ï¼Œä¸“é—¨ä¸ºæŠ€æœ¯å›¢é˜Ÿæä¾›è§£å†³æ–¹æ¡ˆå»ºè®®ï¼ŒåŒæ—¶æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åŸºäºä¸šåŠ¡éœ€æ±‚å’ŒæŠ€æœ¯ç°çŠ¶ï¼Œæä¾›æŠ€æœ¯æ–¹æ¡ˆå»ºè®®ï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€æŠ€æœ¯é€‰å‹ã€å®æ–½è®¡åˆ’ç­‰ã€‚',
        example: 'ä¸šåŠ¡éœ€æ±‚ï¼š"æå‡ç”¨æˆ·ä½“éªŒï¼Œ3ä¸ªæœˆå†…å®Œæˆ"\nå»ºè®®ï¼š"å»ºè®®é‡‡ç”¨æ¸è¿›å¼ä¼˜åŒ–æ–¹æ¡ˆï¼šç¬¬ä¸€é˜¶æ®µ(1ä¸ªæœˆ)ä¼˜åŒ–ç°æœ‰ç•Œé¢ï¼Œç¬¬äºŒé˜¶æ®µ(1.5ä¸ªæœˆ)é‡æ„æ ¸å¿ƒæµç¨‹ï¼Œç¬¬ä¸‰é˜¶æ®µ(0.5ä¸ªæœˆ)æ€§èƒ½ä¼˜åŒ–ã€‚é¢„è®¡æŠ•å…¥3åå¼€å‘äººå‘˜ï¼Œæ€»æˆæœ¬30ä¸‡å…ƒã€‚"'
      },
      education: {
        systemRole: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ•™è‚²é¡¾é—®ï¼Œä¸“é—¨ä¸ºæ•™å¸ˆæä¾›æ•™å­¦æ–¹æ¡ˆå»ºè®®ï¼ŒåŒæ—¶æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åŸºäºå­¦ç”Ÿçš„å­¦ä¹ éœ€æ±‚å’Œæ•™å­¦ç°çŠ¶ï¼Œæä¾›æ•™å­¦å»ºè®®ï¼ŒåŒ…æ‹¬æ•™å­¦æ–¹æ³•ã€è¯¾ç¨‹å®‰æ’ã€å­¦ä¹ æŒ‡å¯¼ç­‰ã€‚',
        example: 'å­¦ç”Ÿéœ€æ±‚ï¼š"ç†è§£é‡å­ç‰©ç†æ³¢ç²’äºŒè±¡æ€§"\nå»ºè®®ï¼š"å»ºè®®é‡‡ç”¨ä¸‰æ­¥æ•™å­¦æ³•ï¼š1)é€šè¿‡åŒç¼å®éªŒè§†é¢‘å»ºç«‹ç›´è§‚è®¤çŸ¥ï¼›2)ç”¨å…‰ç”µæ•ˆåº”å®éªŒç†è§£ç²’å­æ€§ï¼›3)é€šè¿‡è®¡ç®—é¢˜å·©å›ºç†è§£ã€‚é¢„è®¡éœ€è¦4è¯¾æ—¶ï¼Œå»ºè®®å‡†å¤‡å®éªŒææ–™ã€‚"'
      }
    }

    if (!scenario || !scenarioPrompts[scenario]) {
      throw new Error(`æ— æ•ˆçš„åœºæ™¯ç±»å‹: ${scenario}`)
    }
    const prompt = scenarioPrompts[scenario]
    
    // æ„å»ºèŠå¤©å†å²ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«è¯¦ç»†æ—¥å¿—ï¼‰
    const chatContext = buildChatContextWithLogging(chatHistory, 'å¯¹è¯å†å²', 4)
    
    // ä¸ºæ¯ä¸ªåœºæ™¯å®šåˆ¶ç‹¬ç«‹çš„å¢å¼ºæŒ‡ä»¤
    const enhancedInstructions = {
      retail: `ç”Ÿæˆå»ºè®®çš„æŒ‡å¯¼åŸåˆ™ï¼ˆé›¶å”®ä¼ä¸šä¸“ç”¨ï¼‰ï¼š
1. é”€å”®ç­–ç•¥ä¼˜åŒ–ï¼šåŸºäºé¡¾å®¢éœ€æ±‚ç‰¹å¾ï¼Œæä¾›ç²¾å‡†çš„äº§å“æ¨èå’Œé”€å”®ç­–ç•¥
2. åº“å­˜ä¸ä¾›åº”é“¾ï¼šè€ƒè™‘å•†å“åº“å­˜ã€å­£èŠ‚æ€§å› ç´ å’Œä¾›åº”é“¾æ•ˆç‡
3. å®¢æˆ·å…³ç³»ç®¡ç†ï¼šæä¾›å®¢æˆ·ç»´æŠ¤ã€å¤è´­ä¿ƒè¿›å’Œå£ç¢‘è¥é”€çš„å…·ä½“å»ºè®®
4. ä»·æ ¼ç­–ç•¥åˆ¶å®šï¼šå¹³è¡¡åˆ©æ¶¦ç©ºé—´å’Œå¸‚åœºç«äº‰åŠ›ï¼Œæä¾›çµæ´»çš„å®šä»·å»ºè®®
5. æœåŠ¡ä½“éªŒæå‡ï¼šä¼˜åŒ–å”®å‰å’¨è¯¢ã€å”®ä¸­æœåŠ¡å’Œå”®åä¿éšœçš„å…¨æµç¨‹ä½“éªŒ
6. é›¶å”®è¿è¥å®ç”¨æ€§ï¼šç¡®ä¿å»ºè®®ç¬¦åˆé›¶å”®è¡Œä¸šç‰¹ç‚¹ï¼Œæ˜“äºé—¨åº—æ‰§è¡Œ
7. é›¶å”®åœºæ™¯ä¸å½“è¯­è¨€å¤„ç†ï¼šå°†é¡¾å®¢çš„ä¸æ»¡è½¬åŒ–ä¸ºæœåŠ¡æ”¹è¿›å’Œäº§å“ä¼˜åŒ–çš„å…·ä½“è¡ŒåŠ¨æ–¹æ¡ˆ`,
      
      enterprise: `ç”Ÿæˆå»ºè®®çš„æŒ‡å¯¼åŸåˆ™ï¼ˆä¼ä¸šæœåŠ¡ä¸“ç”¨ï¼‰ï¼š
1. å•†ä¸šä»·å€¼é‡åŒ–ï¼šæä¾›å¯è¡¡é‡çš„ROIã€æˆæœ¬èŠ‚çº¦å’Œæ•ˆç‡æå‡æŒ‡æ ‡
2. æŠ€æœ¯å¯è¡Œæ€§è¯„ä¼°ï¼šå¹³è¡¡æŠ€æœ¯å…ˆè¿›æ€§å’Œå®æ–½å¯è¡Œæ€§ï¼Œæä¾›é£é™©æ§åˆ¶å»ºè®®
3. ç»„ç»‡å˜é©ç®¡ç†ï¼šè€ƒè™‘äººå‘˜åŸ¹è®­ã€æµç¨‹è°ƒæ•´å’Œæ–‡åŒ–é€‚åº”çš„å˜é©å»ºè®®
4. åˆè§„ä¸å®‰å…¨ä¿éšœï¼šç¡®ä¿å»ºè®®ç¬¦åˆè¡Œä¸šè§„èŒƒå’Œä¼ä¸šå®‰å…¨æ”¿ç­–è¦æ±‚
5. åˆ†é˜¶æ®µå®æ–½è§„åˆ’ï¼šæä¾›æ¸è¿›å¼å®æ–½æ–¹æ¡ˆï¼Œé™ä½ä¸šåŠ¡ä¸­æ–­é£é™©
6. ä¼ä¸šå†³ç­–æ”¯æŒï¼šä½¿ç”¨å†³ç­–å±‚å…³å¿ƒçš„å•†ä¸šè¯­è¨€ï¼Œçªå‡ºæˆ˜ç•¥ä»·å€¼
7. ä¼ä¸šåœºæ™¯ä¸å½“è¯­è¨€å¤„ç†ï¼šå°†éƒ¨é—¨å†²çªè½¬åŒ–ä¸ºæµç¨‹ä¼˜åŒ–å’Œåä½œæœºåˆ¶æ”¹è¿›å»ºè®®`,
      
      education: `ç”Ÿæˆå»ºè®®çš„æŒ‡å¯¼åŸåˆ™ï¼ˆæ•™è‚²æœåŠ¡ä¸“ç”¨ï¼‰ï¼š
1. å­¦ä¹ æ•ˆæœå¯¼å‘ï¼šåŸºäºå­¦ä¹ ç›®æ ‡å’Œå­¦ç”Ÿç‰¹ç‚¹ï¼Œæä¾›ä¸ªæ€§åŒ–çš„æ•™å­¦å»ºè®®
2. æ•™å­¦èµ„æºé…ç½®ï¼šåˆç†åˆ©ç”¨å¸ˆèµ„ã€æ•™æå’Œæ•™å­¦è®¾å¤‡ï¼Œä¼˜åŒ–èµ„æºé…ç½®
3. å­¦ä¹ è¿›åº¦ç®¡ç†ï¼šæä¾›å·®å¼‚åŒ–çš„å­¦ä¹ è¿›åº¦å®‰æ’å’Œèƒ½åŠ›æå‡è·¯å¾„
4. å®¶æ ¡åä½œä¿ƒè¿›ï¼šå»ºç«‹æœ‰æ•ˆçš„å®¶æ ¡æ²Ÿé€šæœºåˆ¶ï¼Œå½¢æˆæ•™è‚²åˆåŠ›
5. å­¦ä¹ å…´è¶£åŸ¹å…»ï¼šæ³¨é‡å­¦ä¹ åŠ¨æœºæ¿€å‘å’Œå…´è¶£ç»´æŒçš„æ–¹æ³•å»ºè®®
6. æ•™è‚²ä¸“ä¸šæ€§ä¿éšœï¼šç¡®ä¿å»ºè®®ç¬¦åˆæ•™è‚²è§„å¾‹å’Œå­¦ç”Ÿèº«å¿ƒå‘å±•ç‰¹ç‚¹
7. æ•™è‚²åœºæ™¯ä¸å½“è¯­è¨€å¤„ç†ï¼šå°†å­¦ä¹ å›°éš¾è½¬åŒ–ä¸ºæ•™å­¦æ–¹æ³•è°ƒæ•´å’Œå­¦ä¹ æ”¯æŒä¼˜åŒ–å»ºè®®`
    }

    const comprehensivePrompt = [
      {
        role: 'system',
        content: `${prompt.systemRole}\n\n${prompt.context}\n\n${prompt.example}\n\né‡è¦è¦æ±‚ï¼š
1) è¾“å‡ºç®€æ´å»ºè®®ï¼Œç›´è¾¾è¦ç‚¹ï¼›
2) é¿å…åˆ†ç‚¹ã€ç¼–å·ã€è¿‡å¤šé“ºå«ï¼›
3) ä¿æŒå¯æ‰§è¡Œä¸è½åœ°æ€§ï¼›
4) è¯­å¥å®Œæ•´é€šé¡ºã€‚`
      },
      {
        role: 'user',
        content: `å½“å‰å¯¹è¯å†…å®¹ï¼š"${content}"${chatContext}\n\nè¯·ç»™å‡ºç®€æ´çš„å»ºè®®ï¼Œçªå‡ºå¯æ‰§è¡Œè¦ç‚¹ã€‚`
      }
    ]
    
    let resultRaw = await callModelScopeAPI(comprehensivePrompt, 0.3)
    let result = sanitizeFollowUpOutput(resultRaw)
    result = stripLeadingPleasantries(result)

    // è‹¥è¾“å‡ºè¿‡å¼±/æœªæˆå¥ï¼Œåˆ™è¿›è¡Œä¸€æ¬¡ä¸¥æ ¼æç¤ºçš„é‡è¯•ï¼ˆé™æ¸©+æ˜ç¡®ç¦æ­¢å¯’æš„ï¼‰
    if (isWeakOneSentence(result)) {
      const strictPrompt = [
        { role: 'system', content: `${prompt.systemRole}\n\n${prompt.context}\n\n${prompt.example}\n\né‡è¦è¦æ±‚ï¼š\n1) ä»…è¾“å‡ºç®€æ´çš„æ ¸å¿ƒå»ºè®®ï¼Œç¦æ­¢å¯’æš„ã€é—®å€™ä¸å®¢å¥—ï¼›\n2) ä¸åˆ†ç‚¹ï¼›\n3) è¯­å¥å®Œæ•´é€šé¡ºã€‚` },
        { role: 'user', content: `å½“å‰å¯¹è¯å†…å®¹ï¼š"${content}"${chatContext}\n\nè¯·ç›´æ¥ç»™å‡ºç®€æ´çš„æ ¸å¿ƒå»ºè®®ï¼Œç¦æ­¢å¯’æš„ä¸é“ºå«ã€‚` }
      ]
      resultRaw = await callModelScopeAPI(strictPrompt, 0.1)
      result = stripLeadingPleasantries(sanitizeFollowUpOutput(resultRaw))
    }

    // ç›´æ¥ä½¿ç”¨ç»“æœï¼Œæ— é•¿åº¦é™åˆ¶
    const suggestionMessageFinal = ensureCompleteSentence(result.trim())

    // æ„å»ºæ­¥éª¤æ˜¾ç¤º
    const steps = [
      {
        name: 'å»ºè®®å†…å®¹',
        content: suggestionMessageFinal
      }
    ]

    console.groupCollapsed('[LLM] Parsed -> generate_suggestion')
    console.log('suggestionMessage:', truncateForLog(suggestionMessageFinal))
    console.groupEnd()

    return {
      steps,
      suggestionMessage: suggestionMessageFinal,
      structuredOutput: {
        suggestion: suggestionMessageFinal
      }
    }
  } catch (error) {
    console.error('ç”Ÿæˆä¼ä¸šå»ºè®®æ—¶å‡ºé”™:', error)
    throw error
  }
}

// æ–°å¢ï¼šç”Ÿæˆä¼ä¸šç«¯è¿½é—®
const generateEnterpriseFollowUp = async (content, scenario, chatHistory = []) => {
  try {
    const scenarioPrompts = {
      retail: {
        systemRole: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é›¶å”®é”€å”®ä¸“å®¶ï¼Œä¸“é—¨å¸®åŠ©ä¼ä¸šäº†è§£å®¢æˆ·éœ€æ±‚çš„å…³é”®ä¿¡æ¯ï¼ŒåŒæ—¶æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åŸºäºå½“å‰å¯¹è¯ï¼Œè¯†åˆ«éœ€è¦è¿›ä¸€æ­¥äº†è§£çš„å…³é”®ä¿¡æ¯ï¼Œç”Ÿæˆæœ‰é’ˆå¯¹æ€§çš„è¿½é—®ã€‚',
        example: 'å®¢æˆ·è¯´ï¼š"éœ€è¦å•†åŠ¡è¥¿è£…"\nè¿½é—®ï¼š"è¯·é—®æ‚¨çš„å…·ä½“ä½¿ç”¨åœºåˆæ˜¯ä»€ä¹ˆï¼Ÿé¢„ç®—èŒƒå›´å¤§æ¦‚æ˜¯å¤šå°‘ï¼Ÿæ‚¨çš„èº«é«˜ä½“é‡æ˜¯å¤šå°‘ï¼Ÿå¯¹é¢œè‰²å’Œæ¬¾å¼æœ‰ä»€ä¹ˆåå¥½å—ï¼Ÿ"'
      },
      enterprise: {
        systemRole: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¼ä¸šéœ€æ±‚åˆ†æå¸ˆï¼Œä¸“é—¨å¸®åŠ©æŠ€æœ¯å›¢é˜Ÿæ·±å…¥äº†è§£ä¸šåŠ¡éœ€æ±‚ï¼ŒåŒæ—¶æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åŸºäºå½“å‰å¯¹è¯ï¼Œè¯†åˆ«æŠ€æœ¯å®ç°éœ€è¦çš„å…³é”®ä¿¡æ¯ï¼Œç”Ÿæˆæœ‰é’ˆå¯¹æ€§çš„è¿½é—®ã€‚',
        example: 'ä¸šåŠ¡æ–¹è¯´ï¼š"éœ€è¦æå‡ç”¨æˆ·ä½“éªŒ"\nè¿½é—®ï¼š"å…·ä½“å¸Œæœ›æå‡å“ªäº›æ–¹é¢çš„ä½“éªŒï¼Ÿç›®æ ‡ç”¨æˆ·ç¾¤ä½“æ˜¯è°ï¼Ÿå½“å‰çš„ç—›ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿæœ‰å…·ä½“çš„æ—¶é—´è¦æ±‚å—ï¼Ÿé¢„ç®—èŒƒå›´æ˜¯å¤šå°‘ï¼Ÿ"'
      },
      education: {
        systemRole: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ•™è‚²éœ€æ±‚åˆ†æå¸ˆï¼Œä¸“é—¨å¸®åŠ©æ•™å¸ˆäº†è§£å­¦ç”Ÿçš„å­¦ä¹ æƒ…å†µï¼ŒåŒæ—¶æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åŸºäºå½“å‰å¯¹è¯ï¼Œè¯†åˆ«æ•™å­¦éœ€è¦çš„å…³é”®ä¿¡æ¯ï¼Œç”Ÿæˆæœ‰é’ˆå¯¹æ€§çš„è¿½é—®ã€‚',
        example: 'å­¦ç”Ÿè¯´ï¼š"ä¸æ‡‚è¿™ä¸ªæ¦‚å¿µ"\nè¿½é—®ï¼š"æ‚¨ä¹‹å‰å­¦è¿‡ç›¸å…³çš„åŸºç¡€çŸ¥è¯†å—ï¼Ÿæ‚¨æ›´å€¾å‘äºå“ªç§å­¦ä¹ æ–¹å¼ï¼Ÿæ‚¨å¸Œæœ›è¾¾åˆ°ä»€ä¹ˆæ ·çš„ç†è§£ç¨‹åº¦ï¼Ÿæœ‰ä»€ä¹ˆå…·ä½“çš„å­¦ä¹ ç›®æ ‡å—ï¼Ÿ"'
      }
    }

    if (!scenario || !scenarioPrompts[scenario]) {
      throw new Error(`æ— æ•ˆçš„åœºæ™¯ç±»å‹: ${scenario}`)
    }
    const prompt = scenarioPrompts[scenario]
    
    // æ„å»ºèŠå¤©å†å²ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«è¯¦ç»†æ—¥å¿—ï¼‰
    const chatContext = buildChatContextWithLogging(chatHistory, 'å¯¹è¯å†å²', 4)
    
    // ä¸ºæ¯ä¸ªåœºæ™¯å®šåˆ¶ç‹¬ç«‹çš„å¢å¼ºæŒ‡ä»¤
    const enhancedInstructions = {
      retail: `è¿½é—®ç”Ÿæˆçš„æŒ‡å¯¼åŸåˆ™ï¼ˆé›¶å”®ä¼ä¸šä¸“ç”¨ï¼‰ï¼š
1. é”€å”®æœºä¼šæŒ–æ˜ï¼šè¯†åˆ«é¡¾å®¢æ½œåœ¨éœ€æ±‚ï¼Œç”Ÿæˆä¿ƒè¿›æˆäº¤çš„å…³é”®è¿½é—®
2. äº§å“åŒ¹é…ç²¾å‡†åº¦ï¼šé€šè¿‡è¿½é—®äº†è§£é¡¾å®¢å…·ä½“ä½¿ç”¨åœºæ™¯å’Œåå¥½
3. ä»·æ ¼æ•æ„Ÿåº¦æ¢æµ‹ï¼šå·§å¦™äº†è§£é¡¾å®¢é¢„ç®—èŒƒå›´å’Œä»·å€¼è®¤çŸ¥
4. ç«å“å¯¹æ¯”åˆ†æï¼šäº†è§£é¡¾å®¢å¯¹ç«äº‰äº§å“çš„è®¤çŸ¥å’Œæ¯”è¾ƒæ ‡å‡†
5. è´­ä¹°å†³ç­–æµç¨‹ï¼šè¯†åˆ«å½±å“è´­ä¹°å†³ç­–çš„å…³é”®å› ç´ å’Œå†³ç­–äºº
6. é›¶å”®åœºæ™¯é€‚åº”æ€§ï¼šç¡®ä¿è¿½é—®æ–¹å¼ç¬¦åˆé›¶å”®ç¯å¢ƒçš„æ²Ÿé€šç‰¹ç‚¹
7. é›¶å”®åœºæ™¯ä¸å½“è¯­è¨€å¤„ç†ï¼šå°†é¡¾å®¢çš„æŠ±æ€¨è½¬åŒ–ä¸ºäº†è§£çœŸå®éœ€æ±‚çš„è¿½é—®æœºä¼š`,
      
      enterprise: `è¿½é—®ç”Ÿæˆçš„æŒ‡å¯¼åŸåˆ™ï¼ˆä¼ä¸šæœåŠ¡ä¸“ç”¨ï¼‰ï¼š
1. ä¸šåŠ¡éœ€æ±‚æ·±åº¦æŒ–æ˜ï¼šé€šè¿‡è¿½é—®äº†è§£ä¼ä¸šçœŸå®çš„ä¸šåŠ¡ç—›ç‚¹å’Œç›®æ ‡
2. å†³ç­–é“¾æ¡è¯†åˆ«ï¼šäº†è§£ä¼ä¸šå†…éƒ¨å†³ç­–æµç¨‹å’Œå…³é”®å†³ç­–äºº
3. é¢„ç®—ä¸æ—¶é—´çº¦æŸï¼šæ¢æ˜é¡¹ç›®é¢„ç®—èŒƒå›´å’Œå®æ–½æ—¶é—´è¦æ±‚
4. æŠ€æœ¯ç¯å¢ƒè¯„ä¼°ï¼šäº†è§£ä¼ä¸šç°æœ‰æŠ€æœ¯æ¶æ„å’Œé›†æˆè¦æ±‚
5. é£é™©æ‰¿å—èƒ½åŠ›ï¼šè¯„ä¼°ä¼ä¸šå¯¹æ–°æŠ€æœ¯å’Œå˜é©çš„æ¥å—ç¨‹åº¦
6. ä¼ä¸šçº§ä¸“ä¸šæ€§ï¼šä½¿ç”¨ä¼ä¸šå†³ç­–è€…ç†Ÿæ‚‰çš„å•†ä¸šè¯­è¨€è¿›è¡Œè¿½é—®
7. ä¼ä¸šåœºæ™¯ä¸å½“è¯­è¨€å¤„ç†ï¼šå°†å†…éƒ¨åˆ†æ­§è½¬åŒ–ä¸ºäº†è§£å„éƒ¨é—¨éœ€æ±‚çš„è¿½é—®ç­–ç•¥`,
      
      education: `è¿½é—®ç”Ÿæˆçš„æŒ‡å¯¼åŸåˆ™ï¼ˆæ•™è‚²æœåŠ¡ä¸“ç”¨ï¼‰ï¼š
1. å­¦ä¹ ç›®æ ‡æ˜ç¡®åŒ–ï¼šé€šè¿‡è¿½é—®äº†è§£å…·ä½“çš„å­¦ä¹ ç›®æ ‡å’ŒæœŸæœ›æˆæœ
2. å­¦ä¹ èƒ½åŠ›è¯„ä¼°ï¼šäº†è§£å­¦ç”Ÿå½“å‰æ°´å¹³ã€å­¦ä¹ ä¹ æƒ¯å’Œèƒ½åŠ›ç‰¹ç‚¹
3. å­¦ä¹ ç¯å¢ƒåˆ†æï¼šæ¢æ˜å®¶åº­å­¦ä¹ ç¯å¢ƒå’Œå­¦æ ¡æ•™å­¦æ¡ä»¶
4. å­¦ä¹ åŠ¨æœºæ¿€å‘ï¼šäº†è§£å­¦ç”Ÿå…´è¶£ç‚¹å’Œå­¦ä¹ åŠ¨åŠ›æ¥æº
5. å®¶é•¿æœŸæœ›ç®¡ç†ï¼šå¹³è¡¡å®¶é•¿æœŸæœ›å’Œå­¦ç”Ÿå®é™…èƒ½åŠ›çš„å·®å¼‚
6. æ•™è‚²ä¸“ä¸šæ€§ä¿éšœï¼šç¡®ä¿è¿½é—®ç¬¦åˆæ•™è‚²è§„å¾‹å’Œå­¦ç”Ÿå¿ƒç†ç‰¹ç‚¹
7. æ•™è‚²åœºæ™¯ä¸å½“è¯­è¨€å¤„ç†ï¼šå°†å­¦ä¹ æŒ«æŠ˜è½¬åŒ–ä¸ºäº†è§£å­¦ä¹ éšœç¢çš„è¿½é—®æœºä¼š`
    }

    const comprehensivePrompt = [
      {
        role: 'system',
        content: `${prompt.systemRole}\n\n${prompt.context}\n\n${prompt.example}\n\né‡è¦è¦æ±‚ï¼š
1) ç”Ÿæˆç®€æ´è‡ªç„¶çš„è¯¢é—®ï¼›
2) ç›´æ¥è¯¢é—®æœ€å…³é”®çš„ä¿¡æ¯ï¼›
3) è¯­å¥å…·ä½“æ˜ç¡®ã€å®Œæ•´é€šé¡ºã€‚`
      },
      {
        role: 'user',
        content: `å½“å‰å¯¹è¯å†…å®¹ï¼š"${content}"${chatContext}\n\nè¯·ç”Ÿæˆç®€æ´æ˜ç¡®çš„è¯¢é—®ï¼Œæ·±å…¥äº†è§£å…³é”®ä¿¡æ¯ã€‚`
      }
    ]
    
    let resultRaw = await callModelScopeAPI(comprehensivePrompt, 0.3)
    let result = sanitizeFollowUpOutput(resultRaw)
    result = stripLeadingPleasantries(result)

    // è‹¥è¿‡çŸ­æˆ–ç–‘ä¼¼æœªæˆå¥ï¼Œä¸¥æ ¼é‡è¯•ä¸€æ¬¡
    if (isWeakOneSentence(result)) {
      const strictPrompt = [
        { role: 'system', content: `${prompt.systemRole}\n\n${prompt.context}\n\n${prompt.example}\n\né‡è¦è¦æ±‚ï¼š\n1) ä»…è¾“å‡ºç®€æ´çš„è‡ªç„¶è¯­å¥ï¼Œç¦æ­¢å¯’æš„ï¼›\n2) è¯­å¥å®Œæ•´é€šé¡ºã€‚` },
        { role: 'user', content: `å½“å‰å¯¹è¯å†…å®¹ï¼š"${content}"${chatContext}\n\nè¯·ç›´æ¥ç»™å‡ºç®€æ´çš„è‡ªç„¶è¯­å¥ï¼Œç¦æ­¢å¯’æš„ä¸é“ºå«ã€‚` }
      ]
      resultRaw = await callModelScopeAPI(strictPrompt, 0.1)
      result = stripLeadingPleasantries(sanitizeFollowUpOutput(resultRaw))
    }

    // ç®€åŒ–å¤„ç†ï¼Œç›´æ¥ä½¿ç”¨ç»“æœï¼›ç¡®ä¿è¯­å¥å®Œæ•´
    const followUpMessage = ensureQuestionEnding(result.trim())

    // æ„å»ºæ­¥éª¤æ˜¾ç¤º
    const steps = [
      {
        name: 'è¿½é—®å†…å®¹',
        content: followUpMessage
      }
    ]

    console.groupCollapsed('[LLM] Parsed -> generate_followup')
    console.log('followUpMessage:', truncateForLog(followUpMessage))
    console.groupEnd()

    return {
      steps,
      followUpMessage,
      structuredOutput: {
        followUp: followUpMessage
      }
    }
  } catch (error) {
    console.error('ç”Ÿæˆä¼ä¸šè¿½é—®æ—¶å‡ºé”™:', error)
    throw error
  }
}

// è¾…åŠ©å‡½æ•° - ä¿ç•™ç”¨äºå‘åå…¼å®¹
const analyzeContext = async (content) => {
  const prompt = [
    {
      role: 'system',
      content: 'ä½ æ˜¯ä¸€ä¸ªè¯­å¢ƒåˆ†æä¸“å®¶ï¼Œè¯·åˆ†æç”¨æˆ·è¾“å…¥çš„ä¸šåŠ¡åœºæ™¯å’Œä¸Šä¸‹æ–‡ã€‚'
    },
    {
      role: 'user',
      content: `ç”¨æˆ·è¾“å…¥ï¼š"${content}"\n\nè¯·åˆ†æè¿™ä¸ªè¾“å…¥å¯èƒ½æ¶‰åŠçš„ä¸šåŠ¡åœºæ™¯ã€è¡Œä¸šèƒŒæ™¯æˆ–ä½¿ç”¨ç¯å¢ƒã€‚`
    }
  ]
  return await callModelScopeAPI(prompt)
}

const conceptualize = async (content) => {
  const prompt = [
    {
      role: 'system',
      content: 'ä½ æ˜¯ä¸€ä¸ªæ¦‚å¿µè®¾è®¡å¸ˆï¼Œè¯·å°†ç”¨æˆ·éœ€æ±‚è½¬åŒ–ä¸ºå…·ä½“çš„æ¦‚å¿µå’ŒåŠŸèƒ½ç‚¹ã€‚'
    },
    {
      role: 'user',
      content: `åŸºäºç”¨æˆ·è¾“å…¥ï¼š"${content}"\n\nè¯·å°†å…¶æ¦‚å¿µåŒ–ä¸ºå…·ä½“çš„åŠŸèƒ½éœ€æ±‚æˆ–è§£å†³æ–¹æ¡ˆè¦ç‚¹ã€‚`
    }
  ]
  return await callModelScopeAPI(prompt)
}

const detectMissingInfo = async (content) => {
  const prompt = [
    {
      role: 'system',
      content: 'ä½ æ˜¯ä¸€ä¸ªéœ€æ±‚å®Œæ•´æ€§æ£€æŸ¥ä¸“å®¶ï¼Œè¯·è¯†åˆ«ç”¨æˆ·è¾“å…¥ä¸­å¯èƒ½ç¼ºå¤±çš„å…³é”®ä¿¡æ¯ã€‚'
    },
    {
      role: 'user',
      content: `ç”¨æˆ·è¾“å…¥ï¼š"${content}"\n\nè¯·è¯†åˆ«ä¸ºäº†æ›´å¥½åœ°ç†è§£å’Œæ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼Œè¿˜éœ€è¦å“ªäº›é¢å¤–ä¿¡æ¯ï¼Ÿ`
    }
  ]
  return await callModelScopeAPI(prompt)
}

const translateToSolution = async (content) => {
  const prompt = [
    {
      role: 'system',
      content: 'ä½ æ˜¯ä¸€ä¸ªéœ€æ±‚ç¿»è¯‘ä¸“å®¶ï¼Œè¯·å°†ç”¨æˆ·çš„åŸå§‹è¾“å…¥è½¬åŒ–ä¸ºæ¸…æ™°ã€ä¸“ä¸šçš„éœ€æ±‚æè¿°ã€‚'
    },
    {
      role: 'user',
      content: `ç”¨æˆ·åŸå§‹è¾“å…¥ï¼š"${content}"\n\nè¯·å°†å…¶è½¬åŒ–ä¸ºæ¸…æ™°ã€ä¸“ä¸šçš„éœ€æ±‚æè¿°ï¼ŒåŒ…å«å…·ä½“çš„åŠŸèƒ½è¦æ±‚å’ŒæœŸæœ›ç»“æœã€‚`
    }
  ]
  return await callModelScopeAPI(prompt)
}

const optimizeForUser = async (content) => {
  const prompt = [
    {
      role: 'system',
      content: 'ä½ æ˜¯ä¸€ä¸ªç”¨æˆ·ä½“éªŒä¸“å®¶ï¼Œè¯·å°†æŠ€æœ¯æ–¹æ¡ˆè½¬åŒ–ä¸ºç”¨æˆ·æ˜“æ‡‚çš„è¯­è¨€ï¼Œå¹¶æä¾›æ¸…æ™°çš„è¡ŒåŠ¨æŒ‡å—ã€‚'
    },
    {
      role: 'user',
      content: `æŠ€æœ¯æ–¹æ¡ˆï¼š"${content}"\n\nè¯·å°†å…¶è½¬åŒ–ä¸ºç”¨æˆ·å‹å¥½çš„è¯­è¨€ï¼ŒåŒ…å«æ¸…æ™°çš„æ­¥éª¤å’Œé¢„æœŸç»“æœã€‚`
    }
  ]
  return await callModelScopeAPI(prompt)
}

// æ™ºèƒ½éœ€æ±‚åˆ†æå’Œä¿¡æ¯ç¼ºå¤±æ£€æµ‹ - ç²¾å‡†ç‰ˆæœ¬
const analyzeCustomerNeedsWithMissingInfo = async (content, image, scenario, chatHistory = []) => {
  try {
    const scenarioPrompts = {
      retail: {
        systemRole: 'ä½ æ˜¯ä¸“ä¸šçš„é›¶å”®éœ€æ±‚åˆ†æä¸“å®¶ï¼Œèƒ½å¤Ÿé’ˆå¯¹ä»»ä½•äº§å“ç²¾å‡†è¯†åˆ«å…·ä½“çš„å…³é”®ä¿¡æ¯ç‚¹ã€‚',
        instruction: `åˆ†æç”¨æˆ·éœ€æ±‚æ—¶ï¼Œè¦ç”Ÿæˆå…·ä½“çš„ã€å¯æ“ä½œçš„ä¿¡æ¯é€‰é¡¹ï¼Œè€Œä¸æ˜¯æŠ½è±¡æ¦‚å¿µã€‚

ä¾‹å¦‚ï¼š
- ç”¨æˆ·è¯´"æˆ‘è¦ä¹°ä»¶è¡£æœ" â†’ ç”Ÿæˆï¼šå°ºç ã€é¢œè‰²ã€ä»·ä½ã€åœºåˆã€æè´¨
- ç”¨æˆ·è¯´"æˆ‘è¦ä¹°ä¸ªæ‰‹æœº" â†’ ç”Ÿæˆï¼šé¢„ç®—ã€å“ç‰Œã€åŠŸèƒ½éœ€æ±‚ã€å­˜å‚¨å®¹é‡ã€é¢œè‰²
- ç”¨æˆ·è¯´"æˆ‘è¦è£…ä¿®" â†’ ç”Ÿæˆï¼šé¢ç§¯ã€é£æ ¼ã€é¢„ç®—ã€æ—¶é—´ã€æˆ¿é—´ç±»å‹

è¦æ±‚ï¼š
1. æ¯ä¸ªé€‰é¡¹åç§°2-4ä¸ªå­—ï¼Œç®€æ´æ˜äº†
2. å¿…é¡»æ˜¯å…·ä½“çš„ã€å¯ç›´æ¥è¯¢é—®çš„ä¿¡æ¯ç‚¹
3. ä¸è¯¥äº§å“/æœåŠ¡ç›´æ¥ç›¸å…³ï¼Œä¸è¦æŠ½è±¡æ¦‚å¿µ
4. æŒ‰é‡è¦æ€§æ’åºï¼Œæœ€é‡è¦çš„æ”¾å‰é¢`
      },
      enterprise: {
        systemRole: 'ä½ æ˜¯ä¸“ä¸šçš„ä¼ä¸šéœ€æ±‚åˆ†æä¸“å®¶ï¼Œèƒ½å¤Ÿé’ˆå¯¹ä»»ä½•ä¸šåŠ¡éœ€æ±‚ç²¾å‡†è¯†åˆ«å…·ä½“çš„å…³é”®ä¿¡æ¯ç‚¹ã€‚',
        instruction: `åˆ†æä¸šåŠ¡éœ€æ±‚æ—¶ï¼Œè¦ç”Ÿæˆå…·ä½“çš„ã€å¯æ“ä½œçš„ä¿¡æ¯é€‰é¡¹ï¼Œè€Œä¸æ˜¯æŠ½è±¡æ¦‚å¿µã€‚

ä¾‹å¦‚ï¼š
- ç”¨æˆ·è¯´"æˆ‘è¦å¼€å‘ç³»ç»Ÿ" â†’ ç”Ÿæˆï¼šé¢„ç®—è§„æ¨¡ã€å¼€å‘å‘¨æœŸã€ç”¨æˆ·æ•°é‡ã€æ ¸å¿ƒåŠŸèƒ½ã€æŠ€æœ¯æ ˆ
- ç”¨æˆ·è¯´"æˆ‘è¦åšè¥é”€" â†’ ç”Ÿæˆï¼šç›®æ ‡å®¢ç¾¤ã€æ¨å¹¿æ¸ é“ã€æ´»åŠ¨é¢„ç®—ã€æ•ˆæœæœŸæœ›ã€æ—¶é—´å®‰æ’
- ç”¨æˆ·è¯´"æˆ‘è¦åŸ¹è®­å‘˜å·¥" â†’ ç”Ÿæˆï¼šåŸ¹è®­äººæ•°ã€åŸ¹è®­å†…å®¹ã€æ—¶é—´å®‰æ’ã€åŸ¹è®­æ–¹å¼ã€é¢„ç®—èŒƒå›´

è¦æ±‚ï¼š
1. æ¯ä¸ªé€‰é¡¹åç§°2-4ä¸ªå­—ï¼Œç®€æ´æ˜äº†
2. å¿…é¡»æ˜¯å…·ä½“çš„ã€å¯ç›´æ¥è¯¢é—®çš„ä¿¡æ¯ç‚¹
3. ä¸è¯¥ä¸šåŠ¡éœ€æ±‚ç›´æ¥ç›¸å…³ï¼Œä¸è¦æŠ½è±¡æ¦‚å¿µ
4. æŒ‰é‡è¦æ€§æ’åºï¼Œæœ€é‡è¦çš„æ”¾å‰é¢`
      },
      education: {
        systemRole: 'ä½ æ˜¯ä¸“ä¸šçš„æ•™è‚²éœ€æ±‚åˆ†æä¸“å®¶ï¼Œèƒ½å¤Ÿé’ˆå¯¹ä»»ä½•å­¦ä¹ éœ€æ±‚ç²¾å‡†è¯†åˆ«å…·ä½“çš„å…³é”®ä¿¡æ¯ç‚¹ã€‚',
        instruction: `åˆ†æå­¦ä¹ éœ€æ±‚æ—¶ï¼Œè¦ç”Ÿæˆå…·ä½“çš„ã€å¯æ“ä½œçš„ä¿¡æ¯é€‰é¡¹ï¼Œè€Œä¸æ˜¯æŠ½è±¡æ¦‚å¿µã€‚

ä¾‹å¦‚ï¼š
- ç”¨æˆ·è¯´"æˆ‘è¦å­¦è‹±è¯­" â†’ ç”Ÿæˆï¼šå½“å‰æ°´å¹³ã€å­¦ä¹ ç›®æ ‡ã€æ—¶é—´å®‰æ’ã€å­¦ä¹ æ–¹å¼ã€é¢„ç®—è€ƒè™‘
- ç”¨æˆ·è¯´"å­©å­è¦è¡¥æ•°å­¦" â†’ ç”Ÿæˆï¼šå¹´çº§é˜¶æ®µã€è–„å¼±ç¯èŠ‚ã€ä¸Šè¯¾æ—¶é—´ã€æœŸæœ›æ•ˆæœã€è´¹ç”¨é¢„ç®—
- ç”¨æˆ·è¯´"æˆ‘è¦è€ƒè¯" â†’ ç”Ÿæˆï¼šè€ƒè¯•æ—¶é—´ã€åŸºç¡€æƒ…å†µã€å­¦ä¹ æ—¶é—´ã€åŸ¹è®­æ–¹å¼ã€é€šè¿‡ç›®æ ‡

è¦æ±‚ï¼š
1. æ¯ä¸ªé€‰é¡¹åç§°2-4ä¸ªå­—ï¼Œç®€æ´æ˜äº†
2. å¿…é¡»æ˜¯å…·ä½“çš„ã€å¯ç›´æ¥è¯¢é—®çš„ä¿¡æ¯ç‚¹
3. ä¸è¯¥å­¦ä¹ éœ€æ±‚ç›´æ¥ç›¸å…³ï¼Œä¸è¦æŠ½è±¡æ¦‚å¿µ
4. æŒ‰é‡è¦æ€§æ’åºï¼Œæœ€é‡è¦çš„æ”¾å‰é¢`
      }
    }

    const prompt = scenarioPrompts[scenario]
    if (!prompt) {
      throw new Error(`ä¸æ”¯æŒçš„åœºæ™¯ç±»å‹: ${scenario}`)
    }

    // æ„å»ºèŠå¤©å†å²ä¸Šä¸‹æ–‡
    const chatContext = buildChatContextWithLogging(chatHistory, 'èŠå¤©å†å²ä¸Šä¸‹æ–‡', 6)

    const comprehensivePrompt = [
      {
        role: 'system',
        content: `${prompt.systemRole}

${prompt.instruction}

ã€é‡è¦ã€‘è¾“å…¥å†…å®¹è¿‡æ»¤å’Œæ™ºèƒ½å¤„ç†è§„åˆ™ï¼š
1. ä¸å½“è¨€è¯­å¤„ç†ï¼šå¦‚æœç”¨æˆ·è¾“å…¥åŒ…å«è¾±éª‚ã€ç²—ä¿—ã€æ”»å‡»æ€§è¯æ±‡ï¼Œä¸è¦é‡å¤è¿™äº›å†…å®¹ï¼Œè€Œæ˜¯ï¼š
   - è¯†åˆ«ä¸º"ç”¨æˆ·æƒ…ç»ªåŒ–è¡¨è¾¾"æˆ–"æµ‹è¯•æ€§è¾“å…¥"
   - ç†è§£å¯èƒ½çš„çœŸå®æ„å›¾ï¼ˆå¦‚è¡¨è¾¾ä¸æ»¡ã€å¯»æ±‚å¸®åŠ©ã€éšæ„æµ‹è¯•ç­‰ï¼‰
   - ä»¥ä¸“ä¸šã€å‹å¥½çš„æ–¹å¼å›åº”

2. æ— æ„ä¹‰è¾“å…¥å¤„ç†ï¼šå¦‚æœè¾“å…¥æ˜¯ï¼š
   - éšæœºå­—æ¯/æ•°å­—ç»„åˆï¼ˆå¦‚"cnm"ã€"123"ã€"aaa"ï¼‰
   - å•ä¸ªè¯æ±‡æ²¡æœ‰æ˜ç¡®éœ€æ±‚å«ä¹‰
   - æ˜æ˜¾çš„æµ‹è¯•æ€§è¾“å…¥
   è¯†åˆ«ä¸º"éœ€è¦å¼•å¯¼çš„ç”¨æˆ·"ï¼Œå»ºè®®æä¾›çœŸå®éœ€æ±‚

3. è´Ÿé¢æƒ…ç»ªè¯†åˆ«ï¼šå¦‚æœè¾“å…¥è¡¨è¾¾ä¸æ»¡æˆ–è´Ÿé¢æƒ…ç»ªï¼Œè½¬åŒ–ä¸ºäº†è§£é—®é¢˜å’Œæä¾›å¸®åŠ©çš„æœºä¼š

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

ã€éœ€æ±‚ç†è§£ã€‘
ç®€æ˜æ‰¼è¦åœ°æ€»ç»“ç”¨æˆ·çš„æ ¸å¿ƒéœ€æ±‚ï¼ˆä¸è¶…è¿‡30å­—ï¼‰
- å¯¹äºæœ‰æ•ˆéœ€æ±‚ï¼šæ­£å¸¸æ€»ç»“
- å¯¹äºä¸å½“è¾“å…¥ï¼šè¯´æ˜"ç”¨æˆ·æµ‹è¯•è¾“å…¥"æˆ–"ç”¨æˆ·æƒ…ç»ªåŒ–è¡¨è¾¾"
- å¯¹äºæ— æ„ä¹‰è¾“å…¥ï¼šè¯´æ˜"è¾“å…¥å†…å®¹ä¸æ˜ç¡®ï¼Œéœ€è¦å¼•å¯¼"

ã€ä¿¡æ¯é€‰é¡¹ã€‘
é’ˆå¯¹å…·ä½“éœ€æ±‚ç”Ÿæˆé€‰é¡¹ï¼Œæ ¼å¼ï¼šé€‰é¡¹åç§°|è¯¢é—®åŸå› 
- å¯¹äºæœ‰æ•ˆéœ€æ±‚ï¼šæ­£å¸¸ç”Ÿæˆ3-5ä¸ªé€‰é¡¹
- å¯¹äºæ— æ•ˆè¾“å…¥ï¼šè¿”å›"æ— éœ€æ”¶é›†é¢å¤–ä¿¡æ¯"

ã€éœ€æ±‚è½¬è¯‘ã€‘
è½¬åŒ–ä¸ºä¸“ä¸šæè¿°ï¼š
- å¯¹äºæœ‰æ•ˆéœ€æ±‚ï¼šæ­£å¸¸è½¬è¯‘
- å¯¹äºä¸å½“è¾“å…¥ï¼šè½¬è¯‘ä¸º"é¡¾å®¢å¯èƒ½æ­£åœ¨æµ‹è¯•ç³»ç»Ÿæˆ–è¡¨è¾¾æƒ…ç»ªï¼Œå»ºè®®å‹å¥½å¼•å¯¼å…¶æä¾›å…·ä½“éœ€æ±‚"
- å¯¹äºæ— æ„ä¹‰è¾“å…¥ï¼šè½¬è¯‘ä¸º"é¡¾å®¢è¾“å…¥ä¸å¤Ÿæ˜ç¡®ï¼Œå»ºè®®ä¸»åŠ¨è¯¢é—®å¯ä»¥ä¸ºå…¶æä¾›ä»€ä¹ˆå¸®åŠ©"`
      },
      {
        role: 'user', 
        content: `ç”¨æˆ·è¾“å…¥ï¼š"${content}"${image ? '\nï¼ˆç”¨æˆ·è¿˜ä¸Šä¼ äº†ä¸€å¼ å›¾ç‰‡ï¼‰' : ''}${chatContext}

è¯·åˆ†æè¿™ä¸ªè¾“å…¥ï¼Œå¦‚æœæ˜¯ä¸å½“è¨€è¯­æˆ–æ— æ„ä¹‰å†…å®¹ï¼Œè¯·è¿›è¡Œæ™ºèƒ½å¤„ç†ã€‚`
      }
    ]

    const result = await callModelScopeAPI(comprehensivePrompt, 0.1)
    const sanitizedResult = sanitizeOutput(result)
    
    // è§£æç»“æœ
    const needsMatch = sanitizedResult.match(/ã€éœ€æ±‚ç†è§£ã€‘\s*\n([\s\S]*?)(?=\nã€|$)/)
    const optionsMatch = sanitizedResult.match(/ã€ä¿¡æ¯é€‰é¡¹ã€‘\s*\n([\s\S]*?)(?=\nã€|$)/)
    const translationMatch = sanitizedResult.match(/ã€éœ€æ±‚è½¬è¯‘ã€‘\s*\n([\s\S]*?)(?=\nã€|$)/)

    const needsUnderstanding = needsMatch ? needsMatch[1].trim() : 'éœ€æ±‚åˆ†æ'
    const optionsText = optionsMatch ? optionsMatch[1].trim() : ''
    const translation = translationMatch ? translationMatch[1].trim() : content

    // è§£æä¿¡æ¯é€‰é¡¹
    const missingInfoOptions = []
    if (optionsText) {
      const lines = optionsText.split('\n').filter(line => line.trim())
      for (const line of lines) {
        // åŒ¹é…æ ¼å¼ï¼šé€‰é¡¹åç§°|è¯´æ˜
        const match = line.match(/^[â€¢\-\*]?\s*([^|]{2,8})\|(.+)$/)
        if (match) {
          missingInfoOptions.push({
            name: match[1].trim(),
            description: match[2].trim(),
            selected: false
          })
        }
      }
    }

    console.log('[LLM] æ™ºèƒ½éœ€æ±‚åˆ†æç»“æœ:', {
      needsUnderstanding,
      missingInfoOptions,
      translation
    })

    return {
      needsUnderstanding,
      missingInfoOptions,
      translation,
      structuredOutput: {
        needsUnderstanding,
        missingInfoOptions,
        translation
      }
    }

  } catch (error) {
    console.error('æ™ºèƒ½éœ€æ±‚åˆ†æé”™è¯¯:', error)
    throw error
  }
}

// åå•†å»ºè®®å¤„ç†å‡½æ•°
const negotiateSuggestion = async (content, scenario, chatHistory = []) => {
  try {
    console.log('\n=== å¼€å§‹åå•†å»ºè®®å¤„ç† ===')
    console.log('åŸå§‹å»ºè®®:', content.originalSuggestion)
    console.log('åå•†è¯·æ±‚:', content.negotiationRequest)
    console.log('åœºæ™¯:', scenario)

    const chatContext = buildChatContextWithLogging(chatHistory, 'åå•†ä¸Šä¸‹æ–‡', 4)

    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„${scenario}é¡¾é—®ï¼Œæ­£åœ¨æ ¹æ®å®¢æˆ·çš„åå•†è¯·æ±‚ä¼˜åŒ–ä¹‹å‰çš„å»ºè®®ã€‚

è¯·æ ¹æ®å®¢æˆ·çš„åå•†è¦æ±‚ï¼Œå¯¹åŸå§‹å»ºè®®è¿›è¡Œä¿®æ”¹å’Œä¼˜åŒ–ã€‚

è¾“å‡ºè¦æ±‚ï¼š
1. å¿…é¡»åŒ…å«ã€å¤„ç†æ­¥éª¤ã€‘éƒ¨åˆ†ï¼Œè¯¦ç»†è¯´æ˜åå•†å¤„ç†è¿‡ç¨‹
2. å¿…é¡»åŒ…å«ã€ä¼˜åŒ–å»ºè®®ã€‘éƒ¨åˆ†ï¼Œæä¾›ä¿®æ”¹åçš„å®Œæ•´å»ºè®®
3. å»ºè®®è¦å…·ä½“ã€å¯æ“ä½œã€ç¬¦åˆå®¢æˆ·çš„åå•†è¦æ±‚
4. ä¿æŒä¸“ä¸šæ€§å’Œå®ç”¨æ€§ï¼Œè¯­å¥ç®€æ´ã€‚`

    const userPrompt = `åŸå§‹å»ºè®®ï¼š
${content.originalSuggestion}

å®¢æˆ·åå•†è¯·æ±‚ï¼š
${content.negotiationRequest}

è¯·æ ¹æ®å®¢æˆ·çš„åå•†è¦æ±‚ï¼Œä¼˜åŒ–ä¸Šè¿°å»ºè®®ã€‚${chatContext}`

    const messages = [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ]

    console.log('å‘é€åå•†è¯·æ±‚åˆ°LLM...')
    const response = await callModelScopeAPI(messages, 0.7)
    console.log('LLMåå•†å“åº”:', truncateForLog(response))

    const sanitized = sanitizeFollowUpOutput(response)
    const sections = parseSectionsRobust(sanitized)

    const steps = sections['å¤„ç†æ­¥éª¤'] || ['æ­£åœ¨åˆ†æåå•†è¯·æ±‚...', 'ä¼˜åŒ–åŸå§‹å»ºè®®...', 'ç”Ÿæˆåå•†åå»ºè®®...']
    const suggestionMessage = sections['ä¼˜åŒ–å»ºè®®'] || sanitized

    console.log('åå•†å¤„ç†å®Œæˆ')
    console.log('å¤„ç†æ­¥éª¤:', steps)
    console.log('ä¼˜åŒ–å»ºè®®:', truncateForLog(suggestionMessage))

    return {
      steps,
      suggestionMessage
    }

  } catch (error) {
    console.error('åå•†å»ºè®®å¤„ç†é”™è¯¯:', error)
    throw error
  }
}

// åŸºäºé€‰ä¸­çš„ä¿¡æ¯ç”Ÿæˆè¿½é—®
const generateQuestionsBySelectedInfo = async (originalContent, selectedInfoItems, scenario, chatHistory = []) => {
  try {
    const scenarioPrompts = {
      retail: {
        systemRole: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é›¶å”®é”€å”®ä¸“å®¶ï¼Œä¸“é—¨å¸®åŠ©ä¼ä¸šäº†è§£å®¢æˆ·éœ€æ±‚çš„å…³é”®ä¿¡æ¯ï¼ŒåŒæ—¶æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åŸºäºå®¢æˆ·çš„åŸå§‹éœ€æ±‚å’Œä¼ä¸šæ™ºèƒ½åˆ†æè¯†åˆ«å‡ºçš„å…³é”®ä¿¡æ¯ç‚¹ï¼Œç”Ÿæˆæœ‰é’ˆå¯¹æ€§çš„è¿½é—®ã€‚',
        example: 'å®¢æˆ·è¯´ï¼š"éœ€è¦å•†åŠ¡è¥¿è£…"ï¼Œä¼ä¸šå…³æ³¨ï¼šå°ºç ã€é¢œè‰²ã€é¢„ç®—\nè¿½é—®ï¼š"ä¸ºäº†ç»™æ‚¨æ¨èæœ€åˆé€‚çš„å•†åŠ¡è¥¿è£…ï¼Œè¯·å‘ŠçŸ¥æ‚¨çš„å°ºç ã€åå¥½çš„é¢œè‰²å’Œå¤§æ¦‚çš„é¢„ç®—èŒƒå›´ï¼Ÿ"'
      },
      enterprise: {
        systemRole: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¼ä¸šéœ€æ±‚åˆ†æå¸ˆï¼Œä¸“é—¨å¸®åŠ©æŠ€æœ¯å›¢é˜Ÿæ·±å…¥äº†è§£ä¸šåŠ¡éœ€æ±‚ï¼ŒåŒæ—¶æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åŸºäºä¸šåŠ¡éœ€æ±‚å’Œä¼ä¸šæ™ºèƒ½åˆ†æè¯†åˆ«å‡ºçš„å…³é”®ä¿¡æ¯ç‚¹ï¼Œç”Ÿæˆæœ‰é’ˆå¯¹æ€§çš„è¿½é—®ã€‚',
        example: 'ä¸šåŠ¡æ–¹è¯´ï¼š"éœ€è¦æå‡ç”¨æˆ·ä½“éªŒ"ï¼Œä¼ä¸šå…³æ³¨ï¼šç›®æ ‡ç”¨æˆ·ã€å…·ä½“åŠŸèƒ½ã€æ—¶é—´è¦æ±‚\nè¿½é—®ï¼š"ä¸ºäº†åˆ¶å®šæœ€é€‚åˆçš„æ–¹æ¡ˆï¼Œè¯·æ˜ç¡®ç›®æ ‡ç”¨æˆ·ç¾¤ä½“ã€å¸Œæœ›æå‡çš„å…·ä½“åŠŸèƒ½å’Œé¢„æœŸå®Œæˆæ—¶é—´ï¼Ÿ"'
      },
      education: {
        systemRole: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ•™è‚²éœ€æ±‚åˆ†æå¸ˆï¼Œä¸“é—¨å¸®åŠ©æ•™å¸ˆäº†è§£å­¦ç”Ÿçš„å­¦ä¹ æƒ…å†µï¼ŒåŒæ—¶æ™ºèƒ½è¿‡æ»¤å’Œè½¬åŒ–ä¸å½“è¡¨è¾¾ï¼Œç¡®ä¿æ²Ÿé€šä¸“ä¸šåŒ–ã€‚',
        context: 'åŸºäºå­¦ä¹ éœ€æ±‚å’Œä¼ä¸šæ™ºèƒ½åˆ†æè¯†åˆ«å‡ºçš„å…³é”®ä¿¡æ¯ç‚¹ï¼Œç”Ÿæˆæœ‰é’ˆå¯¹æ€§çš„è¿½é—®ã€‚',
        example: 'å­¦ç”Ÿè¯´ï¼š"ä¸æ‡‚æ•°å­¦æ¦‚å¿µ"ï¼Œä¼ä¸šå…³æ³¨ï¼šå¹´çº§ã€å…·ä½“ç« èŠ‚ã€å­¦ä¹ æ–¹å¼\nè¿½é—®ï¼š"ä¸ºäº†åˆ¶å®šä¸ªæ€§åŒ–çš„è¾…å¯¼è®¡åˆ’ï¼Œè¯·å‘ŠçŸ¥æ‚¨çš„å¹´çº§ã€å…·ä½“ä¸æ‡‚çš„ç« èŠ‚å’Œæ‚¨æ›´å–œæ¬¢çš„å­¦ä¹ æ–¹å¼ï¼Ÿ"'
      }
    }

    if (!scenario || !scenarioPrompts[scenario]) {
      throw new Error(`æ— æ•ˆçš„åœºæ™¯ç±»å‹: ${scenario}`)
    }
    const prompt = scenarioPrompts[scenario]
    
    // æ„å»ºèŠå¤©å†å²ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«è¯¦ç»†æ—¥å¿—ï¼‰
    const chatContext = buildChatContextWithLogging(chatHistory, 'èŠå¤©å†å²ä¸Šä¸‹æ–‡', 6)
    
    // ä¸ºæ¯ä¸ªåœºæ™¯å®šåˆ¶ç‹¬ç«‹çš„å¢å¼ºæŒ‡ä»¤
    const enhancedInstructions = {
      retail: `è¿½é—®ç”Ÿæˆçš„æŒ‡å¯¼åŸåˆ™ï¼ˆé›¶å”®ä¼ä¸šä¸“ç”¨ï¼‰ï¼š
1. é”€å”®æœºä¼šæŒ–æ˜ï¼šè¯†åˆ«é¡¾å®¢æ½œåœ¨éœ€æ±‚ï¼Œç”Ÿæˆä¿ƒè¿›æˆäº¤çš„å…³é”®è¿½é—®
2. äº§å“åŒ¹é…ç²¾å‡†åº¦ï¼šé€šè¿‡è¿½é—®äº†è§£é¡¾å®¢å…·ä½“ä½¿ç”¨åœºæ™¯å’Œåå¥½
3. ä»·æ ¼æ•æ„Ÿåº¦æ¢æµ‹ï¼šå·§å¦™äº†è§£é¡¾å®¢é¢„ç®—èŒƒå›´å’Œä»·å€¼è®¤çŸ¥
4. ç«å“å¯¹æ¯”åˆ†æï¼šäº†è§£é¡¾å®¢å¯¹ç«äº‰äº§å“çš„è®¤çŸ¥å’Œæ¯”è¾ƒæ ‡å‡†
5. è´­ä¹°å†³ç­–æµç¨‹ï¼šè¯†åˆ«å½±å“è´­ä¹°å†³ç­–çš„å…³é”®å› ç´ å’Œå†³ç­–äºº
6. é›¶å”®åœºæ™¯é€‚åº”æ€§ï¼šç¡®ä¿è¿½é—®æ–¹å¼ç¬¦åˆé›¶å”®ç¯å¢ƒçš„æ²Ÿé€šç‰¹ç‚¹
7. æ™ºèƒ½ä¿¡æ¯æ•´åˆï¼šå°†AIåˆ†æè¯†åˆ«çš„å…³é”®ä¿¡æ¯ç‚¹è‡ªç„¶èå…¥è¿½é—®ä¸­`,
      
      enterprise: `è¿½é—®ç”Ÿæˆçš„æŒ‡å¯¼åŸåˆ™ï¼ˆä¼ä¸šæœåŠ¡ä¸“ç”¨ï¼‰ï¼š
1. ä¸šåŠ¡éœ€æ±‚æ·±åº¦æŒ–æ˜ï¼šé€šè¿‡è¿½é—®äº†è§£ä¼ä¸šçœŸå®çš„ä¸šåŠ¡ç—›ç‚¹å’Œç›®æ ‡
2. å†³ç­–é“¾æ¡è¯†åˆ«ï¼šäº†è§£ä¼ä¸šå†…éƒ¨å†³ç­–æµç¨‹å’Œå…³é”®å†³ç­–äºº
3. é¢„ç®—ä¸æ—¶é—´çº¦æŸï¼šæ¢æ˜é¡¹ç›®é¢„ç®—èŒƒå›´å’Œå®æ–½æ—¶é—´è¦æ±‚
4. æŠ€æœ¯ç¯å¢ƒè¯„ä¼°ï¼šäº†è§£ä¼ä¸šç°æœ‰æŠ€æœ¯æ¶æ„å’Œé›†æˆè¦æ±‚
5. é£é™©æ‰¿å—èƒ½åŠ›ï¼šè¯„ä¼°ä¼ä¸šå¯¹æ–°æŠ€æœ¯å’Œå˜é©çš„æ¥å—ç¨‹åº¦
6. ä¼ä¸šçº§ä¸“ä¸šæ€§ï¼šä½¿ç”¨ä¼ä¸šå†³ç­–è€…ç†Ÿæ‚‰çš„å•†ä¸šè¯­è¨€è¿›è¡Œè¿½é—®
7. æ™ºèƒ½ä¿¡æ¯æ•´åˆï¼šå°†AIåˆ†æè¯†åˆ«çš„å…³é”®ä¿¡æ¯ç‚¹è‡ªç„¶èå…¥è¿½é—®ä¸­`,
      
      education: `è¿½é—®ç”Ÿæˆçš„æŒ‡å¯¼åŸåˆ™ï¼ˆæ•™è‚²æœåŠ¡ä¸“ç”¨ï¼‰ï¼š
1. å­¦ä¹ ç›®æ ‡æ˜ç¡®åŒ–ï¼šé€šè¿‡è¿½é—®äº†è§£å…·ä½“çš„å­¦ä¹ ç›®æ ‡å’ŒæœŸæœ›æˆæœ
2. å­¦ä¹ èƒ½åŠ›è¯„ä¼°ï¼šäº†è§£å­¦ç”Ÿå½“å‰æ°´å¹³ã€å­¦ä¹ ä¹ æƒ¯å’Œèƒ½åŠ›ç‰¹ç‚¹
3. å­¦ä¹ ç¯å¢ƒåˆ†æï¼šæ¢æ˜å®¶åº­å­¦ä¹ ç¯å¢ƒå’Œå­¦æ ¡æ•™å­¦æ¡ä»¶
4. å­¦ä¹ åŠ¨æœºæ¿€å‘ï¼šäº†è§£å­¦ç”Ÿå…´è¶£ç‚¹å’Œå­¦ä¹ åŠ¨åŠ›æ¥æº
5. å®¶é•¿æœŸæœ›ç®¡ç†ï¼šå¹³è¡¡å®¶é•¿æœŸæœ›å’Œå­¦ç”Ÿå®é™…èƒ½åŠ›çš„å·®å¼‚
6. æ•™è‚²ä¸“ä¸šæ€§ä¿éšœï¼šç¡®ä¿è¿½é—®ç¬¦åˆæ•™è‚²è§„å¾‹å’Œå­¦ç”Ÿå¿ƒç†ç‰¹ç‚¹
7. æ™ºèƒ½ä¿¡æ¯æ•´åˆï¼šå°†AIåˆ†æè¯†åˆ«çš„å…³é”®ä¿¡æ¯ç‚¹è‡ªç„¶èå…¥è¿½é—®ä¸­`
    }

    const selectedItems = selectedInfoItems.map(item => `${item.name}ï¼š${item.description}`).join('\n')

    const comprehensivePrompt = [
      {
        role: 'system',
        content: `${prompt.systemRole}

${prompt.context}

${prompt.example}

${enhancedInstructions[scenario]}

é‡è¦è¦æ±‚ï¼š
1) ç”Ÿæˆç®€æ´è‡ªç„¶çš„è¯¢é—®è¯­å¥ï¼›
2) å°†æ‰€æœ‰é€‰ä¸­çš„ä¿¡æ¯ç‚¹è‡ªç„¶èåˆæˆä¸€ä¸ªè¯­å¥ï¼›
3) ç¡®ä¿å†…å®¹å…·ä½“æ˜ç¡®ä¸”è¯­å¥å®Œæ•´ã€‚`
      },
      {
        role: 'user',
        content: `åŸå§‹éœ€æ±‚ï¼š"${originalContent}"

ä¼ä¸šé€‰ä¸­çš„ä¿¡æ¯ç‚¹ï¼š
${selectedItems}

${chatContext}

è¯·åŸºäºä»¥ä¸Šé€‰ä¸­çš„ä¿¡æ¯ç‚¹ç”Ÿæˆç®€æ´æ˜ç¡®çš„è¯¢é—®è¯­å¥ï¼Œè‡ªç„¶èåˆæ‰€æœ‰ä¿¡æ¯ç‚¹ã€‚`
      }
    ]
    
    let resultRaw = await callModelScopeAPI(comprehensivePrompt, 0.3)
    let result = sanitizeFollowUpOutput(resultRaw)
    result = stripLeadingPleasantries(result)

    // è‹¥è¾“å‡ºè¿‡å¼±/æœªæˆå¥ï¼Œåˆ™è¿›è¡Œä¸€æ¬¡ä¸¥æ ¼æç¤ºçš„é‡è¯•
    if (isWeakOneSentence(result)) {
      const strictPrompt = [
        { role: 'system', content: `${prompt.systemRole}\n\n${prompt.context}\n\n${prompt.example}\n\né‡è¦è¦æ±‚ï¼š\n1) ä»…è¾“å‡ºç®€æ´çš„è‡ªç„¶è¯­å¥ï¼Œç¦æ­¢å¯’æš„ã€é—®å€™ä¸å®¢å¥—ï¼›\n2) å¿…é¡»åŒ…å«æ‰€æœ‰é€‰ä¸­çš„ä¿¡æ¯ç‚¹ï¼›\n3) è¯­å¥å®Œæ•´é€šé¡ºã€‚` },
        { role: 'user', content: `åŸå§‹éœ€æ±‚ï¼š"${originalContent}"\n\né€‰ä¸­çš„ä¿¡æ¯ç‚¹ï¼š\n${selectedItems}\n\nè¯·ç›´æ¥ç»™å‡ºç®€æ´çš„èåˆæ‰€æœ‰ä¿¡æ¯ç‚¹çš„è¯¢é—®è¯­å¥ï¼Œç¦æ­¢å¯’æš„ä¸é“ºå«ã€‚${chatContext}` }
      ]
      resultRaw = await callModelScopeAPI(strictPrompt, 0.1)
      result = stripLeadingPleasantries(sanitizeFollowUpOutput(resultRaw))
    }

    // ç¡®ä¿è¯­å¥å®Œæ•´
    const followUpMessage = ensureQuestionEnding(result.trim())

    console.groupCollapsed('[LLM] Parsed -> generate_questions_by_selected_info')
    console.log('followUpMessage:', truncateForLog(followUpMessage))
    console.groupEnd()

    return followUpMessage

  } catch (error) {
    console.error('ç”Ÿæˆè¿½é—®é”™è¯¯:', error)
    throw error
  }
}

// åå•†è¿½é—®å¤„ç†å‡½æ•°
const negotiateFollowUp = async (content, scenario, chatHistory = []) => {
  try {
    console.log('\n=== å¼€å§‹åå•†è¿½é—®å¤„ç† ===')
    console.log('åŸå§‹è¿½é—®:', content.originalFollowUp)
    console.log('åå•†è¯·æ±‚:', content.negotiationRequest)
    console.log('åœºæ™¯:', scenario)

    const chatContext = buildChatContextWithLogging(chatHistory, 'åå•†ä¸Šä¸‹æ–‡', 4)

    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„${scenario}é¡¾é—®ï¼Œæ­£åœ¨æ ¹æ®å®¢æˆ·çš„åå•†è¯·æ±‚ä¼˜åŒ–ä¹‹å‰çš„è¿½é—®ã€‚

è¯·æ ¹æ®å®¢æˆ·çš„åå•†è¦æ±‚ï¼Œå¯¹åŸå§‹è¿½é—®è¿›è¡Œä¿®æ”¹å’Œä¼˜åŒ–ã€‚

è¾“å‡ºè¦æ±‚ï¼š
1. å¿…é¡»åŒ…å«ã€å¤„ç†æ­¥éª¤ã€‘éƒ¨åˆ†ï¼Œè¯¦ç»†è¯´æ˜åå•†å¤„ç†è¿‡ç¨‹
2. å¿…é¡»åŒ…å«ã€ä¼˜åŒ–è¿½é—®ã€‘éƒ¨åˆ†ï¼Œæä¾›ä¿®æ”¹åçš„å®Œæ•´è¿½é—®
3. è¿½é—®è¦å…·ä½“ã€å¯æ“ä½œã€ç¬¦åˆå®¢æˆ·çš„åå•†è¦æ±‚
4. ä¿æŒä¸“ä¸šæ€§å’Œå®ç”¨æ€§ï¼Œè¯­å¥ç®€æ´ã€‚`

    const userPrompt = `åŸå§‹è¿½é—®ï¼š
${content.originalFollowUp}

å®¢æˆ·åå•†è¯·æ±‚ï¼š
${content.negotiationRequest}

è¯·æ ¹æ®å®¢æˆ·çš„åå•†è¦æ±‚ï¼Œä¼˜åŒ–ä¸Šè¿°è¿½é—®ã€‚${chatContext}`

    const messages = [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ]

    console.log('å‘é€åå•†è¿½é—®è¯·æ±‚åˆ°LLM...')
    const response = await callModelScopeAPI(messages, 0.7)
    console.log('LLMåå•†è¿½é—®å“åº”:', truncateForLog(response))

    const sanitized = sanitizeFollowUpOutput(response)
    const sections = parseSectionsRobust(sanitized)

    const steps = sections['å¤„ç†æ­¥éª¤'] || ['æ­£åœ¨åˆ†æåå•†è¯·æ±‚...', 'ä¼˜åŒ–åŸå§‹è¿½é—®...', 'ç”Ÿæˆåå•†åè¿½é—®...']
    const followUpMessage = sections['ä¼˜åŒ–è¿½é—®'] || sanitized

    console.log('åå•†è¿½é—®å¤„ç†å®Œæˆ')
    console.log('å¤„ç†æ­¥éª¤:', steps)
    console.log('ä¼˜åŒ–è¿½é—®:', truncateForLog(followUpMessage))

    return {
      steps,
      followUpMessage
    }

  } catch (error) {
    console.error('åå•†è¿½é—®å¤„ç†é”™è¯¯:', error)
    throw error
  }
}

// ä¸»è¦çš„LLMå¤„ç†å‡½æ•°
export const processWithLLM = async ({ type, content, image, context, scenario, chatHistory = [] }) => {
  try {
    if (type === 'problem_input') {
      return await processProblemInput(content, image, scenario, chatHistory)
    } else if (type === 'analyze_needs_with_missing_info') {
      return await analyzeCustomerNeedsWithMissingInfo(content, image, scenario, chatHistory)
    } else if (type === 'generate_questions_by_selected_info') {
      const { originalContent, selectedInfoItems } = content
      return await generateQuestionsBySelectedInfo(originalContent, selectedInfoItems, scenario, chatHistory)
    } else if (type === 'solution_response') {
      return await processSolutionResponse(content, scenario, chatHistory)
    } else if (type === 'generate_suggestion') {
      return await generateEnterpriseSuggestion(content, scenario, chatHistory)
    } else if (type === 'generate_followup') {
      return await generateEnterpriseFollowUp(content, scenario, chatHistory)
    } else if (type === 'negotiate_suggestion') {
      return await negotiateSuggestion(content, scenario, chatHistory)
    } else if (type === 'negotiate_followup') {
      return await negotiateFollowUp(content, scenario, chatHistory)
    }
    
    throw new Error('æœªçŸ¥çš„å¤„ç†ç±»å‹')
  } catch (error) {
    console.error('LLMå¤„ç†é”™è¯¯:', error)
    throw error
  }
}

// å¯¼å‡ºå…¶ä»–å¯èƒ½éœ€è¦çš„å‡½æ•°
export {
  callModelScopeAPI,
  analyzeContext,
  conceptualize,
  detectMissingInfo,
  translateToSolution,
  optimizeForUser,
  generateEnterpriseSuggestion,
  generateEnterpriseFollowUp,
  negotiateSuggestion
}
